<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>One NZ — Preston's Toolkit</title>
  <link rel="icon" href="one-nz-logo.jpg" type="image/jpeg">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (read) + ExcelJS (write) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <!-- QR lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <!-- Custom Styles -->
  <link rel="stylesheet" href="style.css">
</head>

<body class="p-4 md:p-8 lg:p-12">

  <div class="max-w-7xl mx-auto space-y-8">

    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 animate-fade-in">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#046b30] to-[#00c5a0] flex items-center justify-center text-white shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
          </svg>
        </div>
        <div>
          <h1 class="text-3xl font-bold tracking-tight text-slate-900">One NZ <span
              class="text-slate-400 font-light">|</span> Preston's Toolkit</h1>
          <p class="text-sm text-slate-500 font-medium">Loan Audit & QR Generator</p>
        </div>
      </div>

      <nav class="flex p-1 bg-white/50 backdrop-blur rounded-2xl border border-slate-200/60 shadow-sm">
        <button id="tabBtnLoan" class="tab-btn flex items-center gap-2 rounded-xl px-6 py-2.5 font-semibold text-sm"
          aria-selected="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <path d="M16 13H8" />
            <path d="M16 17H8" />
            <path d="M10 9H8" />
          </svg>
          Loan Audit
        </button>
        <button id="tabBtnQR" class="tab-btn flex items-center gap-2 rounded-xl px-6 py-2.5 font-semibold text-sm"
          aria-selected="false">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect width="5" height="5" x="3" y="3" rx="1" />
            <rect width="5" height="5" x="16" y="3" rx="1" />
            <rect width="5" height="5" x="3" y="16" rx="1" />
            <path d="M21 16h-3a2 2 0 0 0-2 2v3" />
            <path d="M21 21v.01" />
            <path d="M12 7v3a2 2 0 0 1-2 2H7" />
            <path d="M3 12h.01" />
            <path d="M12 3h.01" />
            <path d="M12 16v.01" />
            <path d="M16 12h1" />
            <path d="M21 12v.01" />
            <path d="M12 21v-1" />
          </svg>
          QR Generator
        </button>
      </nav>
    </header>

    <main class="relative min-h-[600px]">
      <!-- Loan Audit Tab -->
      <section id="tab-loan" class="space-y-6 animate-fade-in">

        <!-- Step 1: Upload -->
        <div class="card p-6 md:p-8">
          <div class="flex items-center gap-3 mb-6">
            <div
              class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
              1</div>
            <h2 class="text-xl font-bold text-slate-800">Upload Serial Report</h2>
          </div>

          <div
            class="flex flex-col md:flex-row gap-4 items-start md:items-center bg-slate-50/50 p-4 rounded-xl border border-slate-100">
            <input id="fileInput" type="file"
              class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-[#00c5a0]/10 file:text-[#046b30] hover:file:bg-[#00c5a0]/20 transition-all" />
            <div id="loadStats" class="text-sm font-medium text-slate-600"></div>
          </div>

          <!-- KPIs -->
          <div id="kpis" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 hidden animate-slide-in">
            <div
              class="bg-emerald-50/50 border border-emerald-100 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
              <div class="text-xs font-semibold text-emerald-600 uppercase tracking-wider mb-1">Available</div>
              <div id="kpiAvailable" class="text-3xl font-bold text-emerald-700">0</div>
            </div>
            <div
              class="bg-blue-50/50 border border-blue-100 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
              <div class="text-xs font-semibold text-blue-600 uppercase tracking-wider mb-1">Allocated</div>
              <div id="kpiAllocated" class="text-3xl font-bold text-blue-700">0</div>
            </div>
            <div
              class="bg-purple-50/50 border border-purple-100 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
              <div class="text-xs font-semibold text-purple-600 uppercase tracking-wider mb-1">Scanned (Unique)</div>
              <div id="kpiScanned" class="text-3xl font-bold text-purple-700">0</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Scan -->
        <div class="card p-6 md:p-8 delay-100">
          <div class="flex items-center gap-3 mb-6">
            <div
              class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
              2</div>
            <h2 class="text-xl font-bold text-slate-800">Scan Devices In-Store</h2>
          </div>

          <div class="space-y-4">
            <label class="text-sm font-medium text-slate-600 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 7V5a2 2 0 0 1 2-2h2" />
                <path d="M17 3h2a2 2 0 0 1 2 2v2" />
                <path d="M21 17v2a2 2 0 0 1-2 2h-2" />
                <path d="M7 21H5a2 2 0 0 1-2-2v-2" />
              </svg>
              Use your USB barcode scanner (auto-add on Enter/Tab)
            </label>
            <div class="flex items-center gap-3">
              <input id="manualSerial" autofocus placeholder="Click here and start scanning..."
                class="flex-1 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-[#00c5a0]/20 transition-shadow" />
              <button id="btnAddSerial" class="btn-primary rounded-xl px-6 py-3 font-semibold">Add</button>
            </div>

            <div
              class="flex items-center justify-between text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100">
              <span>Available marked in-store:</span>
              <strong id="cntAvailInStore" class="text-lg text-[#046b30]">0</strong>
            </div>

            <div id="unknownBox" class="mt-4 hidden bg-red-50 border border-red-100 rounded-xl p-4 animate-slide-in">
              <div class="text-sm font-bold text-red-700 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="8" x2="12" y2="12" />
                  <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
                Unknown Serials
              </div>
              <ul id="unknownList" class="text-sm list-disc pl-5 text-red-600 space-y-1"></ul>
            </div>
          </div>
        </div>

        <!-- Step 3: Available Table -->
        <div class="card p-6 md:p-8 delay-200">
          <div class="flex items-center gap-3 mb-6">
            <div
              class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
              3</div>
            <h2 class="text-xl font-bold text-slate-800">Available — Confirm Quality & Comments</h2>
          </div>

          <div class="table-container">
            <div class="overflow-x-auto">
              <table id="tblAvailable" class="min-w-full text-sm">
                <thead>
                  <tr>
                    <th>Serial</th>
                    <th>Item</th>
                    <th>In Store</th>
                    <th>Condition</th>
                    <th>Action</th>
                    <th>Comments</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <p id="availNote" class="text-xs text-slate-500 mt-3 hidden italic">Showing first 400 rows. Export includes
            all rows.</p>
        </div>

        <!-- Step 4: Allocated Table -->
        <div class="card p-6 md:p-8 delay-300">
          <div class="flex items-center gap-3 mb-6">
            <div
              class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
              4</div>
            <h2 class="text-xl font-bold text-slate-800">Allocated — Contracts & Return Dates</h2>
          </div>

          <div class="table-container">
            <div class="overflow-x-auto">
              <table id="tblAllocated" class="min-w-full text-sm">
                <thead>
                  <tr>
                    <th>Serial</th>
                    <th>Item</th>
                    <th>Signed Contract</th>
                    <th>Due Date</th>
                    <th>Status (Auto)</th>
                    <th>Overdue Actions (Auto)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <p id="allocNote" class="text-xs text-slate-500 mt-3 hidden italic">Showing first 400 rows. Export includes
            all rows.</p>
        </div>

        <!-- Export Section -->
        <div class="card p-6 md:p-8">
          <div class="flex flex-col md:flex-row items-center gap-4">
            <div class="flex-1 w-full">
              <label class="block text-sm font-medium text-slate-700 mb-1">Export Filename</label>
              <input id="fileName" placeholder="e.g. Loan Audit Nov 2023" class="w-full px-4 py-2.5" />
            </div>
            <button id="btnExport"
              class="w-full md:w-auto btn-primary rounded-xl px-8 py-2.5 font-bold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Export Excel (.xlsx)
            </button>
          </div>
          <p class="text-xs text-slate-500 mt-3">Includes: <em>Paste Loan Report</em>, <em>Scan Available</em>,
            <em>Available</em>, <em>Allocated</em>, and <em>Data Validation</em> sheets.
          </p>
          <p id="exportError" class="text-sm text-red-600 mt-2 hidden bg-red-50 p-2 rounded border border-red-100"></p>
        </div>

        <!-- SharePoint Link -->
        <div class="card p-6 md:p-8 bg-slate-50/80 flex flex-col md:flex-row items-center justify-between gap-6">
          <div>
            <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
                <path d="M12 12v9" />
                <path d="m16 16-4-4-4 4" />
              </svg>
              Upload to SharePoint
            </h3>
            <p class="text-slate-600 text-sm">Finished your audit? Upload the exported Excel file to the Loan Phone
              Audits folder.</p>
          </div>
          <a href="https://ahunga.sharepoint.com/:f:/r/sites/RetailResourcesFolder/Shared%20Documents/General/Loan%20Phone%20Audits?csf=1&web=1&e=dEQIKg"
            target="_blank" rel="noopener noreferrer"
            class="btn-primary rounded-xl px-6 py-3 font-bold text-white shadow-md flex items-center gap-2 hover:scale-105 transition-transform">
            Open Folder
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
              <polyline points="15 3 21 3 21 9" />
              <line x1="10" y1="14" x2="21" y2="3" />
            </svg>
          </a>
        </div>
      </section>

      <!-- QR Generator Tab -->
      <section id="tab-qr" class="hidden animate-fade-in max-w-3xl mx-auto">
        <div class="card p-8 text-center">
          <div class="mb-8">
            <div
              class="w-16 h-16 bg-gradient-to-br from-[#046b30] to-[#00c5a0] rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="5" height="5" x="3" y="3" rx="1" />
                <rect width="5" height="5" x="16" y="3" rx="1" />
                <rect width="5" height="5" x="3" y="16" rx="1" />
                <path d="M21 16h-3a2 2 0 0 0-2 2v3" />
                <path d="M21 21v.01" />
                <path d="M12 7v3a2 2 0 0 1-2 2H7" />
                <path d="M3 12h.01" />
                <path d="M12 3h.01" />
                <path d="M12 16v.01" />
                <path d="M16 12h1" />
                <path d="M21 12v.01" />
                <path d="M12 21v-1" />
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-900">QR Code Generator</h2>
            <p class="text-slate-500 mt-2">Create branded QR codes instantly.</p>
          </div>

          <div class="space-y-6">
            <div class="flex flex-col sm:flex-row gap-3 items-stretch">
              <input id="qrLinkInput" type="text" placeholder="https://www.one.nz" value="https://www.one.nz"
                inputmode="url" class="flex-1 min-w-[240px] px-4 py-3 text-lg" />
              <button id="qrBtnGenerate" class="btn-primary rounded-xl px-8 py-3 font-bold text-white shadow-md">
                Generate
              </button>
            </div>

            <div id="qrErr"
              class="hidden text-red-700 bg-red-50 border border-red-200 rounded-xl px-4 py-3 text-sm font-medium animate-slide-in">
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-inner inline-block">
              <div class="rounded-xl overflow-hidden bg-white">
                <canvas id="qrCanvas"
                  style="display:block; width:100%; height:auto; max-width: 400px; margin: 0 auto;"></canvas>
              </div>
            </div>

            <div>
              <button id="qrBtnDownload"
                class="btn-secondary rounded-xl px-6 py-2.5 font-semibold text-sm flex items-center gap-2 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Download PNG
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="text-center text-slate-400 text-sm py-8">
      <p>Preston's Toolkit. Internal Use Only.</p>
    </footer>
  </div>

  <script>
    // --------- Tab Switcher ---------
    (function () {
      const btnLoan = document.getElementById('tabBtnLoan');
      const btnQR = document.getElementById('tabBtnQR');
      const tabLoan = document.getElementById('tab-loan');
      const tabQR = document.getElementById('tab-qr');

      function show(which) {
        const isLoan = which === 'loan';
        tabLoan.classList.toggle('hidden', !isLoan);
        tabQR.classList.toggle('hidden', isLoan);
        btnLoan.setAttribute('aria-selected', String(isLoan));
        btnQR.setAttribute('aria-selected', String(!isLoan));
        if (!isLoan) {
          window.dispatchEvent(new CustomEvent('qr-tab-shown'));
        }
      }
      btnLoan.addEventListener('click', () => show('loan'));
      btnQR.addEventListener('click', () => show('qr'));
    })();
  </script>

  <script>
    // --------- Loan Audit logic ---------
    (function () {
      const toSerial = (v) => {
        if (v === null || v === undefined) return "";
        const s = String(v).trim();
        return s.replace(/\\D/g, "");
      };

      const CONDITION_OPTIONS = [
        "Useable Condition",
        "Device is damaged/Unusable",
        "Not fit for purpose: Button phone, Data stick, Vodafone Branded device, iPhone 8 or lower",
        "Lost/Unable to Locate",
        "Pending Check"
      ];

      const CONDITION_TO_ACTION = {
        "Useable Condition": "Ensure device is reset, charged and ready to be loaned out",
        "Device is damaged/Unusable": "Follow process on K Hub article https://k-hub.vodafone.nz/pronto-how-to-charge-for-a-loan-phone",
        "Not fit for purpose: Button phone, Data stick, Vodafone Branded device, iPhone 8 or lower": "Raise request with Sales Ops to remove device from Fleet. Once removed, recycle as per BAU swap kit process",
        "Lost/Unable to Locate": "Try located device. If unable to find, Blocklist device and request Sales Operations to remove. Once confirmed, recycle as per BAU swap kit process.",
        "Pending Check": "Run Check"
      };

      let rawRows = [];
      let availableRows = [];
      let allocatedRows = [];
      let scanned = new Set();

      // Elements
      const elFile = document.getElementById("fileInput");
      const elStats = document.getElementById("loadStats");
      const elKpis = document.getElementById("kpis");
      const elKpiAvail = document.getElementById("kpiAvailable");
      const elKpiAlloc = document.getElementById("kpiAllocated");
      const elKpiScan = document.getElementById("kpiScanned");
      const elFileName = document.getElementById("fileName");
      const elBtnExport = document.getElementById("btnExport");
      const elTblAvailBody = document.querySelector("#tblAvailable tbody");
      const elTblAllocBody = document.querySelector("#tblAllocated tbody");
      const elAvailNote = document.getElementById("availNote");
      const elAllocNote = document.getElementById("allocNote");
      const elCntAvailInStore = document.getElementById("cntAvailInStore");
      const elUnknownBox = document.getElementById("unknownBox");
      const elUnknownList = document.getElementById("unknownList");
      const elManual = document.getElementById("manualSerial");
      const elAddSerial = document.getElementById("btnAddSerial");
      const elExportError = document.getElementById("exportError");

      // Render condition list + mapping
      (function () {
        const condList = document.getElementById("condList");
        CONDITION_OPTIONS.forEach((c) => {
          const li = document.createElement("li"); li.textContent = c; condList.appendChild(li);
        });
        const condBody = document.getElementById("condMapBody");
        CONDITION_OPTIONS.forEach((c) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td class="p-2 font-medium">${c}</td><td class="p-2 text-slate-600">${CONDITION_TO_ACTION[c] || ""}</td>`;
          condBody.appendChild(tr);
        });
      })();

      // Load report
      elFile.addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        elFileName.value = file.name.replace(/\\.[^.]+$/, "");
        const ab = await file.arrayBuffer();
        const wb = XLSX.read(ab, { type: "array" });
        const sheetName = wb.SheetNames.find(n => /paste/i.test(n)) || wb.SheetNames[0];
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: "" });

        rawRows = rows.filter((r) => {
          const maybeHdr = String(r["Item"]).toLowerCase() === "item" && String(r["Serial#"]).toLowerCase().includes("serial");
          const allBlank = Object.values(r).every(v => String(v).trim() === "");
          return !maybeHdr && !allBlank;
        }).map((r) => ({
          Item: r["Item"] ?? "",
          Serial: (String(r["Serial#"] || "")).trim(),
          SerialDigits: toSerial(r["Serial#"]),
          SerialDescription: r["Serial Description"] ?? r["SerialDescription"] ?? "",
          Warehouse: r["Warehouse"] ?? "",
          Name: r["Name"] ?? "",
          Availability: (r["Availability"] ?? "").toString().trim(),
          Contract: r["Contract#"] ?? "",
          Consign: r["Consign#"] ?? "",
          CS: r["CS"] ?? "",
          Repair: r["Repair#"] ?? "",
          RS: r["RS"] ?? "",
          Condition: r["Condition"] ?? "",
          Description: r["Description"] ?? "",
          Created: r["Created"] ?? ""
        }));

        availableRows = rawRows.filter(r => (r.Availability || "").toLowerCase() === "available")
          .map(r => ({ ...r, InStore: "Not Scanned", ConditionChoice: "Useable Condition", Comments: "" }));
        allocatedRows = rawRows.filter(r => (r.Availability || "").toLowerCase() !== "available")
          .map(r => ({ ...r, SignedContract: "Yes", DueDate: "", Status: "", OverdueActions: "", ConditionChoice: "Useable Condition" }));
        scanned.clear();
        elUnknownList.innerHTML = "";
        elUnknownBox.classList.add("hidden");

        elKpis.classList.remove("hidden");
        elKpiAvail.textContent = availableRows.length;
        elKpiAlloc.textContent = allocatedRows.length;
        elKpiScan.textContent = scanned.size;

        renderAvailable();
        renderAllocated();
        elBtnExport.disabled = false;
        elStats.textContent = `Loaded ${rawRows.length} rows from “${sheetName}”.`;
        elManual.focus();
      });

      function renderAvailable() {
        elTblAvailBody.innerHTML = "";
        const max = Math.min(400, availableRows.length);
        for (let i = 0; i < max; i++) {
          const r = availableRows[i];
          const tr = document.createElement("tr"); tr.className = "border-b hover:bg-slate-50";
          const tdS = document.createElement("td"); tdS.className = "p-3 mono font-medium"; tdS.textContent = r.SerialDigits || r.Serial;
          const tdI = document.createElement("td"); tdI.className = "p-3"; tdI.textContent = r.Item;
          const tdIS = document.createElement("td"); tdIS.className = "p-3";
          const selIS = document.createElement("select"); selIS.className = "border rounded-lg px-2 py-1.5 text-sm bg-white focus:ring-2 focus:ring-[#00c5a0]/20";
          ["Not Scanned", "Yes"].forEach(v => { const o = document.createElement("option"); o.value = v; o.textContent = v; if (r.InStore === v) o.selected = true; selIS.appendChild(o); });
          selIS.addEventListener("change", (e) => { r.InStore = e.target.value; updateCounts(); });
          tdIS.appendChild(selIS);

          const tdC = document.createElement("td"); tdC.className = "p-3";
          const selC = document.createElement("select"); selC.className = "border rounded-lg px-2 py-1.5 text-sm bg-white w-full min-w-[180px] focus:ring-2 focus:ring-[#00c5a0]/20";
          CONDITION_OPTIONS.forEach(opt => { const o = document.createElement("option"); o.value = opt; o.textContent = opt; if (r.ConditionChoice === opt) o.selected = true; selC.appendChild(o); });
          selC.addEventListener("change", (e) => { r.ConditionChoice = e.target.value; tdA.textContent = CONDITION_TO_ACTION[e.target.value] || ""; });
          tdC.appendChild(selC);

          const tdA = document.createElement("td"); tdA.className = "p-3 text-slate-600 text-xs"; tdA.textContent = CONDITION_TO_ACTION[r.ConditionChoice] || "";
          const tdCom = document.createElement("td"); tdCom.className = "p-3";
          const inp = document.createElement("input"); inp.className = "border rounded-lg px-2 py-1.5 text-sm w-full focus:ring-2 focus:ring-[#00c5a0]/20"; inp.value = r.Comments || "";
          inp.addEventListener("input", (e) => r.Comments = e.target.value);
          tdCom.appendChild(inp);

          tr.append(tdS, tdI, tdIS, tdC, tdA, tdCom);
          elTblAvailBody.appendChild(tr);
        }
        elAvailNote.classList.toggle("hidden", availableRows.length <= 400);
        updateCounts();
      }

      function renderAllocated() {
        elTblAllocBody.innerHTML = "";
        const max = Math.min(400, allocatedRows.length);
        for (let i = 0; i < max; i++) {
          const r = allocatedRows[i];
          const tr = document.createElement("tr"); tr.className = "border-b hover:bg-slate-50";
          const tdS = document.createElement("td"); tdS.className = "p-3 mono font-medium"; tdS.textContent = r.SerialDigits || r.Serial;
          const tdI = document.createElement("td"); tdI.className = "p-3"; tdI.textContent = r.Item;
          const tdSC = document.createElement("td"); tdSC.className = "p-3";
          const sel = document.createElement("select"); sel.className = "border rounded-lg px-2 py-1.5 text-sm bg-white focus:ring-2 focus:ring-[#00c5a0]/20";
          ["Yes", "No"].forEach(v => { const o = document.createElement("option"); o.value = v; o.textContent = v; if (r.SignedContract === v) o.selected = true; sel.appendChild(o); });
          sel.addEventListener("change", (e) => r.SignedContract = e.target.value);
          const tdDue = document.createElement("td"); tdDue.className = "p-3";
          const inp = document.createElement("input"); inp.type = "date"; inp.className = "border rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-[#00c5a0]/20"; inp.value = r.DueDate || "";
          inp.addEventListener("input", (e) => r.DueDate = e.target.value);
          tdSC.appendChild(sel); tdDue.appendChild(inp);
          const tdStatus = document.createElement("td"); tdStatus.className = "p-3 text-slate-400 italic text-xs"; tdStatus.textContent = "(Excel formula)";
          const tdAct = document.createElement("td"); tdAct.className = "p-3 text-slate-400 italic text-xs"; tdAct.textContent = "(Excel XLOOKUP)";
          tr.append(tdS, tdI, tdSC, tdDue, tdStatus, tdAct);
          elTblAllocBody.appendChild(tr);
        }
        elAllocNote.classList.toggle("hidden", allocatedRows.length <= 400);
      }

      function updateCounts() {
        const availInStore = availableRows.filter(r => r.InStore === "Yes").length;
        elCntAvailInStore.textContent = String(availInStore);
        elKpiScan.textContent = String(scanned.size);
      }

      function addScan(value) {
        const s = toSerial(value);
        if (!s) return;
        scanned.add(s);
        const r = availableRows.find(x => (x.SerialDigits || x.Serial) === s);
        if (r) { r.InStore = "Yes"; updateCounts(); renderAvailable(); }
        else {
          const li = document.createElement("li"); li.textContent = s; elUnknownList.appendChild(li);
          elUnknownBox.classList.remove("hidden");
        }
      }

      elManual.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === "Tab") {
          e.preventDefault();
          addScan(e.target.value);
          e.target.value = "";
          e.target.focus();
        }
      });
      elAddSerial.addEventListener("click", () => {
        addScan(elManual.value);
        elManual.value = "";
        elManual.focus();
      });

      document.getElementById("btnExport").addEventListener("click", async () => {
        elExportError.classList.add("hidden");
        elExportError.textContent = "";
        try {
          if (!rawRows.length) {
            alert("Please upload your Pronto report first."); return;
          }
          const wb = new ExcelJS.Workbook();

          const dv = wb.addWorksheet("Data Validation");
          dv.addRow(["status", "Device condition", "Store actions"]);
          const STATUS_ACTION_ROWS = [
            { status: "Within Timeframe", action: "No Action" },
            { status: "Overdue: Less than 2 weeks", action: "Contact customer to return device. Set clear timeframe of a week to have device returned or customer will be charged unless a new reasonable timeframe is agree by customer and Retail Lead. Return device and re issue new agreement with new timeframe as due date. Send customer email clearly stating new timeframe." },
            { status: "Overdue: More than 2 weeks", action: "Contact customer to return device. Set clear timeframe of a 3 days to have device returned or customer will be charged. If customer is not contactable, Blocklist device an await  3 days for the customer to return. If not returned, return device in pronto, raise request with sales operations to charge the customer and remove the device from your fleet." },
            { status: "Missing a signed contract instore", action: "Investigate why there is no contract with person who issued loan phone, provide appropriate action e.g., training/set expectations. Contact customer to arrange time to re visit store and sign contract." }
          ];
          STATUS_ACTION_ROWS.forEach(r => dv.addRow([r.status, "", r.action]));
          const condToAction = {
            "Useable Condition": "Ensure device is reset, charged and ready to be loaned out",
            "Device is damaged/Unusable": "Follow process on K Hub article https://k-hub.vodafone.nz/pronto-how-to-charge-for-a-loan-phone",
            "Not fit for purpose: Button phone, Data stick, Vodafone Branded device, iPhone 8 or lower": "Raise request with Sales Ops to remove device from Fleet. Once removed, recycle as per BAU swap kit process",
            "Lost/Unable to Locate": "Try located device. If unable to find, Blocklist device and request Sales Operations to remove. Once confirmed, recycle as per BAU swap kit process.",
            "Pending Check": "Run Check"
          };
          CONDITION_OPTIONS.forEach(c => dv.addRow(["", c, (condToAction[c] || "")]));

          dv.getCell("E1").value = "Device condition list";
          CONDITION_OPTIONS.forEach((c, i) => dv.getCell(`E${i + 2}`).value = c);
          const condListRef = `'Data Validation'!$E$2:$E$${CONDITION_OPTIONS.length + 1}`;

          const raw = wb.addWorksheet("Paste Loan Report");
          raw.addRow(["Item", "Serial#", "Serial Description", "Warehouse", "Name", "Availability", "Contract#", "Consign#", "CS", "Repair#", "RS", "Condition", "Description", "Created"]);
          rawRows.forEach(r => raw.addRow([r.Item, r.SerialDigits || r.Serial, r.SerialDescription, r.Warehouse, r.Name, r.Availability, r.Contract, r.Consign, r.CS, r.Repair, r.RS, r.Condition, r.Description, r.Created]));

          const scan = wb.addWorksheet("Scan Available devices here");
          scan.addRow(["Scan Devices here", "Device Status", "Action"]);
          Array.from(scanned).forEach(s => {
            let status = "Unknown";
            let action = "";
            if (availableRows.some(r => (r.SerialDigits || r.Serial) === s)) {
              status = "Available";
            } else if (allocatedRows.some(r => (r.SerialDigits || r.Serial) === s)) {
              status = "Device in allocated state but physically in store";
              action = "Check for paperwork. Return device in Pronto.";
            }
            scan.addRow([s, status, action]);
          });

          const wsA = wb.addWorksheet("Available");
          wsA.addRow(["Item", "Serial#", "Serial Description", "Warehouse", "Name", "Availability", "Contract#", "Consign#", "Condition", "Description", "Created", "In Store", "Condition", "Action based on condition", "Comments"]);
          availableRows.forEach(r => wsA.addRow([r.Item, String(r.SerialDigits || r.Serial), r.SerialDescription, r.Warehouse, r.Name, "Available", r.Contract, r.Consign, r.Condition, r.Description, r.Created, r.InStore, r.ConditionChoice || "Useable Condition", "", r.Comments || ""]));
          const lastRowA = wsA.rowCount;
          if (lastRowA > 1) {
            wsA.dataValidations.add(`N2:N${lastRowA}`, { type: "list", allowBlank: true, formulae: [condListRef], showErrorMessage: true, errorStyle: "stop", errorTitle: "Invalid choice", error: "Pick a value from the dropdown." });
            for (let r = 2; r <= lastRowA; r++) {
              wsA.getCell(`O${r}`).value = { formula: `IFERROR(XLOOKUP(N${r},'Data Validation'!$B:$B,'Data Validation'!$C:$C,""),"")` };
              wsA.getCell(`O${r}`).alignment = { wrapText: true };
            }
          }

          const wsL = wb.addWorksheet("Allocated");
          wsL.addRow(["Item", "Serial#", "Serial Description", "Warehouse", "Name", "Availability", "Contract#", "Consign#", "Condition", "Description", "Created", "Signed contract", "Contract Actions", "Due Date", "Days overdue", "Status", "Overdue Actions"]);
          allocatedRows.forEach(r => wsL.addRow([r.Item, String(r.SerialDigits || r.Serial), r.SerialDescription, r.Warehouse, r.Name, r.Availability, r.Contract, r.Consign, r.Condition, r.Description, r.Created, r.SignedContract, "", r.DueDate || "", "", "", ""]));
          const lastRowL = wsL.rowCount;
          if (lastRowL > 1) {
            for (let r = 2; r <= lastRowL; r++) {
              wsL.getCell(`O${r}`).value = { formula: `IF(N${r}="","",MAX(0,TODAY()-N${r}))` };
              wsL.getCell(`P${r}`).value = { formula: `IF(L${r}="No","Missing a signed contract instore",IF(N${r}="","",IF(TODAY()-N${r}>14,"Overdue: More than 2 weeks",IF(TODAY()-N${r}>0,"Overdue: Less than 2 weeks","Within Timeframe"))))` };
              wsL.getCell(`Q${r}`).value = { formula: `IFERROR(XLOOKUP(P${r},'Data Validation'!$A:$A,'Data Validation'!$C:$C,""),"")` };
              wsL.getCell(`Q${r}`).alignment = { wrapText: true };
            }
          }

          const fileBase = (elFileName.value || "Loan Audit");
          const buffer = await wb.xlsx.writeBuffer();
          const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a"); a.href = url; a.download = `${fileBase}.xlsx`; document.body.appendChild(a); a.click(); a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
        } catch (err) {
          console.error(err);
          elExportError.textContent = "Export failed. If this persists, try Chrome/Edge desktop and ensure file is opened from disk.";
          elExportError.classList.remove("hidden");
        }
      });
    })();
  </script>

  <script>
    // --------- QR Generator ---------
    (function () {
      const canvas = document.getElementById('qrCanvas');
      const ctx = canvas.getContext('2d');
      const input = document.getElementById('qrLinkInput');
      const errBox = document.getElementById('qrErr');

      let lastUrl = '';

      function cssPixelsToBacking(px) { return Math.max(1, Math.round(px * (window.devicePixelRatio || 1))); }
      function targetDisplaySize() {
        const shell = canvas.parentElement.getBoundingClientRect();
        const width = Math.round(shell.width || 0);
        return width > 0 ? Math.min(640, Math.max(240, width - 2)) : 360;
      }

      async function render(url) {
        errBox.classList.add('hidden');
        if (!url) return;
        if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

        if (!window.QRCode || typeof QRCode.create !== 'function') {
          if (typeof QRCode.toDataURL !== 'function') {
            errBox.classList.remove('hidden');
            errBox.textContent = 'QR library failed to load.';
            return;
          }
        }

        try {
          const qr = QRCode.create(url, { errorCorrectionLevel: 'H' });
          const modules = qr.modules;
          const size = modules.size;

          const display = targetDisplaySize();
          const margin = 2;
          const cellSize = display / (size + margin * 2);

          const w = cssPixelsToBacking(display);
          const h = cssPixelsToBacking(display);
          canvas.width = w; canvas.height = h;
          canvas.style.width = display + 'px';
          canvas.style.height = 'auto';

          ctx.scale(w / display, h / display);

          // --- 1. Liquid Glass Background ---
          // Create a mesh-like gradient background
          const bgGrad = ctx.createLinearGradient(0, 0, display, display);
          bgGrad.addColorStop(0, '#f0fdf4'); // Very light green
          bgGrad.addColorStop(0.5, '#ffffff');
          bgGrad.addColorStop(1, '#ecfdf5'); // Minty white

          ctx.fillStyle = bgGrad;
          ctx.fillRect(0, 0, display, display);

          // Add soft "liquid" blobs
          const drawBlob = (x, y, r, color) => {
            ctx.beginPath();
            const g = ctx.createRadialGradient(x, y, 0, x, y, r);
            g.addColorStop(0, color);
            g.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = g;
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
          };

          // Subtle background blobs for depth
          drawBlob(display * 0.2, display * 0.2, display * 0.4, 'rgba(4, 107, 48, 0.05)');
          drawBlob(display * 0.8, display * 0.8, display * 0.4, 'rgba(0, 197, 160, 0.08)');
          drawBlob(display * 0.8, display * 0.2, display * 0.3, 'rgba(4, 107, 48, 0.03)');

          // --- 2. Glossy Modules ---
          // Gradient for the modules themselves
          const modGrad = ctx.createLinearGradient(0, 0, display, display);
          modGrad.addColorStop(0, '#046b30');
          modGrad.addColorStop(1, '#00c5a0');

          const offset = margin * cellSize;

          // Helper: Finder Pattern Areas
          const isFinder = (c, r) => {
            return (r < 7 && c < 7) || (r < 7 && c >= size - 7) || (r >= size - 7 && c < 7);
          };

          // Helper: Center Logo Area (exclude 5x5 area in middle)
          const centerStart = Math.floor(size / 2) - 2;
          const centerEnd = Math.floor(size / 2) + 2;
          const isCenter = (c, r) => c >= centerStart && c <= centerEnd && r >= centerStart && r <= centerEnd;

          ctx.fillStyle = modGrad;

          // Add a subtle drop shadow to modules for "floating" effect
          ctx.shadowColor = "rgba(0, 197, 160, 0.2)";
          ctx.shadowBlur = 4;
          ctx.shadowOffsetY = 2;

          for (let r = 0; r < size; r++) {
            for (let c = 0; c < size; c++) {
              if (modules.get(c, r) && !isFinder(c, r) && !isCenter(c, r)) {
                const x = offset + c * cellSize;
                const y = offset + r * cellSize;

                // Draw "Liquid" Droplet (Rounded Rect)
                const pad = cellSize * 0.1;
                const modSize = cellSize - pad * 2;
                const radius = modSize * 0.4; // Very round

                ctx.beginPath();
                ctx.roundRect(x + pad, y + pad, modSize, modSize, radius);
                ctx.fill();

                // Add a tiny white highlight for gloss
                ctx.save();
                ctx.fillStyle = "rgba(255,255,255,0.3)";
                ctx.beginPath();
                ctx.arc(x + cellSize * 0.35, y + cellSize * 0.35, modSize * 0.15, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
              }
            }
          }

          // Reset Shadow
          ctx.shadowColor = "transparent";
          ctx.shadowBlur = 0;
          ctx.shadowOffsetY = 0;

          // --- 3. Custom Finder Patterns (Liquid Style) ---
          const drawFinder = (cx, cy) => {
            const outerSize = cellSize * 7;
            const x = offset + cx * cellSize;
            const y = offset + cy * cellSize;

            // Outer Ring (Gradient Stroke)
            const ringGrad = ctx.createLinearGradient(x, y, x + outerSize, y + outerSize);
            ringGrad.addColorStop(0, '#046b30');
            ringGrad.addColorStop(1, '#00c5a0');

            ctx.strokeStyle = ringGrad;
            ctx.lineWidth = cellSize;
            ctx.lineCap = "round";
            ctx.beginPath();
            const rOuter = cellSize * 2;
            ctx.roundRect(x + cellSize / 2, y + cellSize / 2, outerSize - cellSize, outerSize - cellSize, rOuter);
            ctx.stroke();

            // Inner Dot (Liquid Sphere)
            ctx.fillStyle = ringGrad;
            const innerSize = cellSize * 3;
            const centerOffset = (outerSize - innerSize) / 2;
            const ix = x + centerOffset;
            const iy = y + centerOffset;

            ctx.beginPath();
            ctx.roundRect(ix, iy, innerSize, innerSize, innerSize * 0.4);
            ctx.fill();

            // Gloss on inner dot
            ctx.fillStyle = "rgba(255,255,255,0.4)";
            ctx.beginPath();
            ctx.arc(ix + innerSize * 0.3, iy + innerSize * 0.3, innerSize * 0.15, 0, Math.PI * 2);
            ctx.fill();
          };

          drawFinder(0, 0); // TL
          drawFinder(size - 7, 0); // TR
          drawFinder(0, size - 7); // BL

          // --- 4. Seamless Glass Logo ---
          const centerPx = display / 2;
          const logoSize = display * 0.22;

          // Glass Container (Blurry, semi-transparent)
          ctx.save();
          ctx.shadowColor = "rgba(0,0,0,0.1)";
          ctx.shadowBlur = 15;
          ctx.shadowOffsetY = 5;

          ctx.beginPath();
          ctx.arc(centerPx, centerPx, logoSize / 2 + 4, 0, Math.PI * 2);
          ctx.fillStyle = "rgba(255, 255, 255, 0.9)"; // More opaque for image backing
          ctx.fill();
          ctx.restore();

          // Draw Image Logo
          // We need to load the image first. 
          // Note: In a real app, we'd preload this. Here we await it.
          const logoImg = new Image();
          logoImg.src = "one-nz-logo.jpg";

          // Wrap image loading in a promise
          await new Promise((resolve, reject) => {
            if (logoImg.complete) resolve();
            logoImg.onload = resolve;
            logoImg.onerror = () => {
              console.warn("Logo failed to load, skipping");
              resolve(); // Continue without logo
            };
          });

          if (logoImg.complete && logoImg.naturalWidth > 0) {
            ctx.save();
            // Clip to circle
            ctx.beginPath();
            ctx.arc(centerPx, centerPx, logoSize / 2, 0, Math.PI * 2);
            ctx.clip();

            // Draw image centered and covering the area
            ctx.drawImage(logoImg, centerPx - logoSize / 2, centerPx - logoSize / 2, logoSize, logoSize);
            ctx.restore();

            // Add a glossy shine over the logo
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerPx, centerPx, logoSize / 2, 0, Math.PI * 2);
            const shine = ctx.createLinearGradient(centerPx - logoSize, centerPx - logoSize, centerPx + logoSize, centerPx + logoSize);
            shine.addColorStop(0, "rgba(255,255,255,0.1)");
            shine.addColorStop(0.5, "rgba(255,255,255,0)");
            shine.addColorStop(1, "rgba(255,255,255,0.1)");
            ctx.fillStyle = shine;
            ctx.fill();
            ctx.restore();
          }

        } catch (e) {
          console.error(e);
          const qrPx = Math.max(180, Math.min(1200, targetDisplaySize()));
          const dataUrl = await QRCode.toDataURL(url, { errorCorrectionLevel: 'H', margin: 1, width: qrPx });
          const img = new Image();
          img.src = dataUrl;
          await img.decode();
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }
      }

      document.getElementById('qrBtnGenerate').addEventListener('click', async () => {
        lastUrl = (input.value || '').trim();
        await render(lastUrl);
      });

      document.getElementById('qrBtnDownload').addEventListener('click', () => {
        if (!canvas.width) return;
        const a = document.createElement('a');
        a.download = 'qr-code.png';
        a.href = canvas.toDataURL('image/png');
        a.click();
      });

      window.addEventListener('qr-tab-shown', () => {
        lastUrl = (input.value || '').trim() || lastUrl;
        if (lastUrl) render(lastUrl);
      });

      let resizeTimer;
      window.addEventListener('resize', () => {
        if (!lastUrl) return;
        const visible = !document.getElementById('tab-qr').classList.contains('hidden');
        if (!visible) return;
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => render(lastUrl), 150);
      }, { passive: true });
    })();
  </script>
</body>

</html>