<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>One NZ — Tools (Loan Audit + QR Generator)</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (read) + ExcelJS (write) for Loan Audit -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <!-- QR lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 10px 20px rgba(0,0,0,0.06); }
    .tab-btn[aria-selected="true"] { background:#0f172a; color:#fff; }
    .tab-btn { background: #e2e8f0; color:#0f172a; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <header class="mb-4 md:mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h1 class="text-2xl md:text-3xl font-bold">One NZ — Tools</h1>
        <nav class="flex gap-2">
          <button id="tabBtnLoan" class="tab-btn rounded-2xl px-4 py-2 font-semibold" aria-selected="true">Loan Audit</button>
          <button id="tabBtnQR" class="tab-btn rounded-2xl px-4 py-2 font-semibold" aria-selected="false">QR Generator</button>
        </nav>
      </div>
    </header>

    <main>
      <!-- Loan Audit Tab -->
      <section id="tab-loan" class="space-y-5">
        <div class="card p-5">
          <h2 class="text-xl font-semibold mb-3">1) Upload serial report</h2>
          <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
            <input id="fileInput" type="file" class="block"/>
            <div id="loadStats" class="text-sm text-slate-600"></div>
          </div>
          <div id="kpis" class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4 hidden">
            <div class="bg-slate-100 rounded-xl p-3">
              <div class="text-xs text-slate-500">Available</div>
              <div id="kpiAvailable" class="text-2xl font-semibold">0</div>
            </div>
            <div class="bg-slate-100 rounded-xl p-3">
              <div class="text-xs text-slate-500">Allocated</div>
              <div id="kpiAllocated" class="text-2xl font-semibold">0</div>
            </div>
            <div class="bg-slate-100 rounded-xl p-3">
              <div class="text-xs text-slate-500">Scanned (unique)</div>
              <div id="kpiScanned" class="text-2xl font-semibold">0</div>
            </div>
          </div>
        </div>

        <div class="card p-5">
          <h2 class="text-xl font-semibold mb-3">2) Scan devices in-store</h2>
          <div>
            <label class="text-sm font-medium">Use your USB barcode scanner (auto-add on Enter/Tab)</label>
            <div class="flex items-center gap-2 mt-2">
              <input id="manualSerial" autofocus placeholder="Click here and start scanning — auto-add on Enter/Tab"
                    class="w-full border rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-black/10"/>
              <button id="btnAddSerial" class="rounded-2xl px-4 py-2 border">Add</button>
            </div>
            <div class="mt-3 text-sm text-slate-600">
              <div>Available marked in-store: <strong id="cntAvailInStore">0</strong></div>
            </div>
            <div id="unknownBox" class="mt-3 hidden">
              <div class="text-sm font-semibold">Unknown serials</div>
              <ul id="unknownList" class="text-sm list-disc pl-4"></ul>
            </div>
          </div>
        </div>

        <div class="card p-5">
          <h2 class="text-xl font-semibold mb-3">3) Available — confirm quality & comments</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm" id="tblAvailable">
              <thead>
                <tr class="bg-slate-100">
                  <th class="p-2 text-left">Serial</th>
                  <th class="p-2 text-left">Item</th>
                  <th class="p-2 text-left">In Store</th>
                  <th class="p-2 text-left">Condition</th>
                  <th class="p-2 text-left">Action</th>
                  <th class="p-2 text-left">Comments</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <p id="availNote" class="text-xs text-slate-500 mt-2 hidden">Showing first 400 rows. Export includes all rows.</p>
        </div>

        <div class="card p-5">
          <h2 class="text-xl font-semibold mb-3">4) Allocated — contracts & return dates</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm" id="tblAllocated">
              <thead>
                <tr class="bg-slate-100">
                  <th class="p-2 text-left">Serial</th>
                  <th class="p-2 text-left">Item</th>
                  <th class="p-2 text-left">Signed contract</th>
                  <th class="p-2 text-left">Due Date</th>
                  <th class="p-2 text-left">Status (auto on export)</th>
                  <th class="p-2 text-left">Overdue Actions (auto on export)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <p id="allocNote" class="text-xs text-slate-500 mt-2 hidden">Showing first 400 rows. Export includes all rows.</p>
        </div>

        <div class="card p-5">
          <div class="flex items-center gap-3">
            <input id="fileName" placeholder="File name" class="border rounded-xl px-3 py-2 max-w-sm" />
            <button id="btnExport" class="rounded-2xl px-4 py-2 border bg-black text-white hover:bg-black/90 disabled:opacity-50" disabled>Export Excel (.xlsx)</button>
          </div>
          <p class="text-xs text-slate-500 mt-2">Export includes: <em>Paste Loan Report</em>, <em>Scan Available devices here</em>, <em>Available</em>, <em>Allocated</em>, and a <em>Data Validation</em> sheet with dropdowns and lookups.</p>
          <p id="exportError" class="text-sm text-red-600 mt-2 hidden"></p>
        </div>

        <div class="card p-5">
          <h3 class="text-lg font-semibold mb-2">Validation & Actions</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <div class="font-medium mb-2">Allowed Conditions (default = Useable Condition)</div>
              <ul id="condList" class="list-disc pl-5 text-sm"></ul>
            </div>
            <div>
              <div class="font-medium mb-2">Condition → Action (Available tab)</div>
              <table class="text-sm min-w-full">
                <thead>
                  <tr class="bg-slate-100">
                    <th class="p-2 text-left">Condition</th>
                    <th class="p-2 text-left">Store action</th>
                  </tr>
                </thead>
                <tbody id="condMapBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- QR Generator Tab -->
      <section id="tab-qr" class="space-y-5 hidden">
        <div class="card p-5">
          <h2 class="text-xl font-semibold mb-3">QR Generator</h2>
          <div class="space-y-3">
            <div class="flex gap-2 flex-wrap items-center">
              <input id="qrLinkInput" type="text" placeholder="Enter or paste a URL" value="https://www.one.nz" inputmode="url"
                     class="flex-1 min-w-[240px] border rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-black/10">
              <div class="flex gap-2">
                <button id="qrBtnGenerate" class="rounded-xl px-4 py-2 font-semibold text-white"
                        style="background:linear-gradient(45deg,#046b30,#00c5a0)">Generate</button>
                <button id="qrBtnDownload" class="rounded-xl px-4 py-2 font-semibold text-[#0a3] bg-[#eef3f1]">Download</button>
              </div>
            </div>
            <div id="qrErr" class="hidden text-red-700 bg-red-50 border border-red-200 rounded-lg px-3 py-2 text-sm"></div>
            <div class="rounded-2xl overflow-hidden bg-white">
              <canvas id="qrCanvas" style="display:block; width:100%; height:auto;"></canvas>
            </div>
            <div class="text-slate-600 text-sm">Canvas is redrawn when the tab is shown or on Generate.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
// --------- Tab Switcher ---------
(function(){
  const btnLoan = document.getElementById('tabBtnLoan');
  const btnQR = document.getElementById('tabBtnQR');
  const tabLoan = document.getElementById('tab-loan');
  const tabQR = document.getElementById('tab-qr');

  function show(which){
    const isLoan = which === 'loan';
    tabLoan.classList.toggle('hidden', !isLoan);
    tabQR.classList.toggle('hidden', isLoan);
    btnLoan.setAttribute('aria-selected', String(isLoan));
    btnQR.setAttribute('aria-selected', String(!isLoan));
    if (!isLoan) {
      // Notify QR module that its tab is now visible so it can render at correct size
      window.dispatchEvent(new CustomEvent('qr-tab-shown'));
    }
  }
  btnLoan.addEventListener('click', ()=>show('loan'));
  btnQR.addEventListener('click', ()=>show('qr'));
})();
</script>

<script>
// --------- Loan Audit logic (unchanged from v3 aside from placement) ---------
(function(){
  const toSerial = (v) => {
    if (v === null || v === undefined) return "";
    const s = String(v).trim();
    return s.replace(/\\D/g, "");
  };

  const CONDITION_OPTIONS = [
    "Useable Condition",
    "Device is damaged/Unusable",
    "Not fit for purpose: Button phone, Data stick, Vodafone Branded device, iPhone 8 or lower",
    "Lost/Unable to Locate",
    "Pending Check"
  ];

  const CONDITION_TO_ACTION = {
    "Useable Condition": "Ensure device is reset, charged and ready to be loaned out",
    "Device is damaged/Unusable": "Follow process on K Hub article https://k-hub.vodafone.nz/pronto-how-to-charge-for-a-loan-phone",
    "Not fit for purpose: Button phone, Data stick, Vodafone Branded device, iPhone 8 or lower": "Raise request with Sales Ops to remove device from Fleet. Once removed, recycle as per BAU swap kit process",
    "Lost/Unable to Locate": "Try located device. If unable to find, Blocklist device and request Sales Operations to remove. Once confirmed, recycle as per BAU swap kit process.",
    "Pending Check": "Run Check"
  };

  const STATUS_ACTION_ROWS = [
    { status: "Within Timeframe", action: "No action" },
    { status: "Overdue: Less than 2 weeks", action: "Follow up with customer to arrange return" },
    { status: "Overdue: More than 2 weeks", action: "Escalate and arrange immediate return" },
    { status: "Missing a signed contract instore", action: "Obtain signed contract immediately" }
  ];

  let rawRows = [];
  let availableRows = [];
  let allocatedRows = [];
  let scanned = new Set();

  // Elements
  const elFile = document.getElementById("fileInput");
  const elStats = document.getElementById("loadStats");
  const elKpis = document.getElementById("kpis");
  const elKpiAvail = document.getElementById("kpiAvailable");
  const elKpiAlloc = document.getElementById("kpiAllocated");
  const elKpiScan = document.getElementById("kpiScanned");
  const elFileName = document.getElementById("fileName");
  const elBtnExport = document.getElementById("btnExport");
  const elTblAvailBody = document.querySelector("#tblAvailable tbody");
  const elTblAllocBody = document.querySelector("#tblAllocated tbody");
  const elAvailNote = document.getElementById("availNote");
  const elAllocNote = document.getElementById("allocNote");
  const elCntAvailInStore = document.getElementById("cntAvailInStore");
  const elUnknownBox = document.getElementById("unknownBox");
  const elUnknownList = document.getElementById("unknownList");
  const elManual = document.getElementById("manualSerial");
  const elAddSerial = document.getElementById("btnAddSerial");
  const elExportError = document.getElementById("exportError");

  // Render condition list + mapping
  (function(){
    const condList = document.getElementById("condList");
    CONDITION_OPTIONS.forEach((c)=>{
      const li=document.createElement("li"); li.textContent=c; condList.appendChild(li);
    });
    const condBody = document.getElementById("condMapBody");
    CONDITION_OPTIONS.forEach((c)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td class="p-2">${c}</td><td class="p-2">${CONDITION_TO_ACTION[c]||""}</td>`;
      condBody.appendChild(tr);
    });
  })();

  // Load report
  elFile.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    elFileName.value = file.name.replace(/\\.[^.]+$/, "");
    const ab = await file.arrayBuffer();
    const wb = XLSX.read(ab, { type: "array" });
    const sheetName = wb.SheetNames.find(n => /paste/i.test(n)) || wb.SheetNames[0];
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: "" });

    rawRows = rows.filter((r)=>{
      const maybeHdr = String(r["Item"]).toLowerCase()==="item" && String(r["Serial#"]).toLowerCase().includes("serial");
      const allBlank = Object.values(r).every(v => String(v).trim()==="");
      return !maybeHdr && !allBlank;
    }).map((r)=> ({
      Item: r["Item"] ?? "",
      Serial: (String(r["Serial#"]||"")).trim(),
      SerialDigits: toSerial(r["Serial#"]),
      SerialDescription: r["Serial Description"] ?? r["SerialDescription"] ?? "",
      Warehouse: r["Warehouse"] ?? "",
      Name: r["Name"] ?? "",
      Availability: (r["Availability"] ?? "").toString().trim(),
      Contract: r["Contract#"] ?? "",
      Consign: r["Consign#"] ?? "",
      CS: r["CS"] ?? "",
      Repair: r["Repair#"] ?? "",
      RS: r["RS"] ?? "",
      Condition: r["Condition"] ?? "",
      Description: r["Description"] ?? "",
      Created: r["Created"] ?? ""
    }));

    availableRows = rawRows.filter(r => (r.Availability||"").toLowerCase()==="available")
                           .map(r => ({...r, InStore: "Not Scanned", ConditionChoice: "Useable Condition", Comments: ""}));
    allocatedRows = rawRows.filter(r => (r.Availability||"").toLowerCase()!=="available")
                           .map(r => ({...r, SignedContract: "Yes", DueDate: "", Status: "", OverdueActions: "", ConditionChoice: "Useable Condition"}));
    scanned.clear();
    elUnknownList.innerHTML = "";
    elUnknownBox.classList.add("hidden");

    elKpis.classList.remove("hidden");
    elKpiAvail.textContent = availableRows.length;
    elKpiAlloc.textContent = allocatedRows.length;
    elKpiScan.textContent = scanned.size;

    renderAvailable();
    renderAllocated();
    elBtnExport.disabled = false;
    elStats.textContent = `Loaded ${rawRows.length} rows from “${sheetName}”.`;
    elManual.focus();
  });

  function renderAvailable(){
    elTblAvailBody.innerHTML = "";
    const max = Math.min(400, availableRows.length);
    for (let i=0; i<max; i++){
      const r = availableRows[i];
      const tr = document.createElement("tr"); tr.className="border-b";
      const tdS = document.createElement("td"); tdS.className="p-2 mono"; tdS.textContent=r.SerialDigits || r.Serial;
      const tdI = document.createElement("td"); tdI.className="p-2"; tdI.textContent=r.Item;
      const tdIS = document.createElement("td"); tdIS.className="p-2";
      const selIS = document.createElement("select"); selIS.className="border rounded-xl px-2 py-1";
      ["Not Scanned","Yes"].forEach(v => { const o=document.createElement("option"); o.value=v; o.textContent=v; if (r.InStore===v) o.selected=true; selIS.appendChild(o); });
      selIS.addEventListener("change", (e)=>{ r.InStore = e.target.value; updateCounts(); });
      tdIS.appendChild(selIS);

      const tdC = document.createElement("td"); tdC.className="p-2";
      const selC = document.createElement("select"); selC.className="border rounded-xl px-2 py-1 w-full";
      CONDITION_OPTIONS.forEach(opt => { const o=document.createElement("option"); o.value=opt; o.textContent=opt; if (r.ConditionChoice===opt) o.selected=true; selC.appendChild(o); });
      selC.addEventListener("change", (e)=>{ r.ConditionChoice = e.target.value; tdA.textContent = CONDITION_TO_ACTION[e.target.value] || ""; });
      tdC.appendChild(selC);

      const tdA = document.createElement("td"); tdA.className="p-2"; tdA.textContent = CONDITION_TO_ACTION[r.ConditionChoice] || "";
      const tdCom = document.createElement("td"); tdCom.className="p-2";
      const inp = document.createElement("input"); inp.className="border rounded-xl px-2 py-1 w-full"; inp.value=r.Comments||"";
      inp.addEventListener("input", (e)=> r.Comments = e.target.value);
      tdCom.appendChild(inp);

      tr.append(tdS, tdI, tdIS, tdC, tdA, tdCom);
      elTblAvailBody.appendChild(tr);
    }
    elAvailNote.classList.toggle("hidden", availableRows.length<=400);
    updateCounts();
  }

  function renderAllocated(){
    elTblAllocBody.innerHTML = "";
    const max = Math.min(400, allocatedRows.length);
    for (let i=0; i<max; i++){
      const r = allocatedRows[i];
      const tr = document.createElement("tr"); tr.className="border-b";
      const tdS = document.createElement("td"); tdS.className="p-2 mono"; tdS.textContent=r.SerialDigits || r.Serial;
      const tdI = document.createElement("td"); tdI.className="p-2"; tdI.textContent=r.Item;
      const tdSC = document.createElement("td"); tdSC.className="p-2";
      const sel = document.createElement("select"); sel.className="border rounded-xl px-2 py-1";
      ["Yes","No"].forEach(v => { const o=document.createElement("option"); o.value=v; o.textContent=v; if (r.SignedContract===v) o.selected=true; sel.appendChild(o);});
      sel.addEventListener("change", (e)=> r.SignedContract = e.target.value);
      const tdDue = document.createElement("td"); tdDue.className="p-2";
      const inp = document.createElement("input"); inp.type="date"; inp.className="border rounded-xl px-2 py-1"; inp.value=r.DueDate||"";
      inp.addEventListener("input", (e)=> r.DueDate = e.target.value);
      tdSC.appendChild(sel); tdDue.appendChild(inp);
      const tdStatus = document.createElement("td"); tdStatus.className="p-2 text-slate-500"; tdStatus.textContent="(Excel formula)";
      const tdAct = document.createElement("td"); tdAct.className="p-2 text-slate-500"; tdAct.textContent="(Excel XLOOKUP)";
      tr.append(tdS, tdI, tdSC, tdDue, tdStatus, tdAct);
      elTblAllocBody.appendChild(tr);
    }
    elAllocNote.classList.toggle("hidden", allocatedRows.length<=400);
  }

  function updateCounts(){
    const availInStore = availableRows.filter(r => r.InStore === "Yes").length;
    elCntAvailInStore.textContent = String(availInStore);
    elKpiScan.textContent = String(scanned.size);
  }

  function addScan(value){
    const s = toSerial(value);
    if (!s) return;
    scanned.add(s);
    const r = availableRows.find(x => (x.SerialDigits||x.Serial) === s);
    if (r){ r.InStore = "Yes"; updateCounts(); renderAvailable(); }
    else {
      const li=document.createElement("li"); li.textContent = s; elUnknownList.appendChild(li);
      elUnknownBox.classList.remove("hidden");
    }
  }

  elManual.addEventListener("keydown", (e)=>{
    if (e.key === "Enter" || e.key === "Tab"){
      e.preventDefault();
      addScan(e.target.value);
      e.target.value = "";
      e.target.focus();
    }
  });
  elAddSerial.addEventListener("click", ()=>{
    addScan(elManual.value);
    elManual.value = "";
    elManual.focus();
  });

  document.getElementById("btnExport").addEventListener("click", async () => {
    elExportError.classList.add("hidden");
    elExportError.textContent = "";
    try {
      if (!rawRows.length){
        alert("Please upload your Pronto report first."); return;
      }
      const wb = new ExcelJS.Workbook();

      const dv = wb.addWorksheet("Data Validation");
      dv.addRow(["status", "Device condition", "Store actions"]);
      const statusBlock = [
        ["Within Timeframe", "", "No action"],
        ["Overdue: Less than 2 weeks", "", "Follow up with customer to arrange return"],
        ["Overdue: More than 2 weeks", "", "Escalate and arrange immediate return"],
        ["Missing a signed contract instore", "", "Obtain signed contract immediately"]
      ];
      statusBlock.forEach(r => dv.addRow(r));
      const condToAction = {
        "Useable Condition": "Ensure device is reset, charged and ready to be loaned out",
        "Device is damaged/Unusable": "Follow process on K Hub article https://k-hub.vodafone.nz/pronto-how-to-charge-for-a-loan-phone",
        "Not fit for purpose: Button phone, Data stick, Vodafone Branded device, iPhone 8 or lower": "Raise request with Sales Ops to remove device from Fleet. Once removed, recycle as per BAU swap kit process",
        "Lost/Unable to Locate": "Try located device. If unable to find, Blocklist device and request Sales Operations to remove. Once confirmed, recycle as per BAU swap kit process.",
        "Pending Check": "Run Check"
      };
      CONDITION_OPTIONS.forEach(c => dv.addRow(["", c, (condToAction[c]||"")]));

      dv.getCell("E1").value = "Device condition list";
      CONDITION_OPTIONS.forEach((c,i)=> dv.getCell(`E${i+2}`).value = c);
      const condListRef = `'Data Validation'!$E$2:$E$${CONDITION_OPTIONS.length+1}`;

      const raw = wb.addWorksheet("Paste Loan Report");
      raw.addRow(["Item","Serial#","Serial Description","Warehouse","Name","Availability","Contract#","Consign#","CS","Repair#","RS","Condition","Description","Created"]);
      rawRows.forEach(r => raw.addRow([r.Item, r.SerialDigits || r.Serial, r.SerialDescription, r.Warehouse, r.Name, r.Availability, r.Contract, r.Consign, r.CS, r.Repair, r.RS, r.Condition, r.Description, r.Created]));

      const scan = wb.addWorksheet("Scan Available devices here");
      scan.addRow(["Scan Devices here", "Device Status"]);
      Array.from(scanned).forEach(s => {
        const status = availableRows.some(r => (r.SerialDigits||r.Serial)===s) ? "Available" : (allocatedRows.some(r => (r.SerialDigits||r.Serial)===s) ? "Allocated" : "Unknown");
        scan.addRow([s, status]);
      });

      const wsA = wb.addWorksheet("Available");
      wsA.addRow(["Item","Serial#","Serial Description","Warehouse","Name","Availability","Contract#","Consign#","Condition","Description","Created","In Store","Condition","Action based on condition","Comments"]);
      availableRows.forEach(r => wsA.addRow([r.Item, String(r.SerialDigits || r.Serial), r.SerialDescription, r.Warehouse, r.Name, "Available", r.Contract, r.Consign, r.Condition, r.Description, r.Created, r.InStore, r.ConditionChoice || "Useable Condition", "", r.Comments || ""]));
      const lastRowA = wsA.rowCount;
      if (lastRowA > 1){
        wsA.dataValidations.add(`N2:N${lastRowA}`, { type:"list", allowBlank:true, formulae:[condListRef], showErrorMessage:true, errorStyle:"stop", errorTitle:"Invalid choice", error:"Pick a value from the dropdown." });
        for (let r=2; r<=lastRowA; r++){
          wsA.getCell(`O${r}`).value = { formula: `IFERROR(XLOOKUP(N${r},'Data Validation'!$B:$B,'Data Validation'!$C:$C,""),"")` };
          wsA.getCell(`O${r}`).alignment = { wrapText: true };
        }
      }

      const wsL = wb.addWorksheet("Allocated");
      wsL.addRow(["Item","Serial#","Serial Description","Warehouse","Name","Availability","Contract#","Consign#","Condition","Description","Created","Signed contract","Contract Actions","Due Date","Days overdue","Status","Overdue Actions"]);
      allocatedRows.forEach(r => wsL.addRow([r.Item, String(r.SerialDigits || r.Serial), r.SerialDescription, r.Warehouse, r.Name, r.Availability, r.Contract, r.Consign, r.Condition, r.Description, r.Created, r.SignedContract, "", r.DueDate || "", "", "", ""]));
      const lastRowL = wsL.rowCount;
      if (lastRowL > 1){
        for (let r=2; r<=lastRowL; r++){
          wsL.getCell(`O${r}`).value = { formula: `IF(N${r}="","",MAX(0,TODAY()-N${r}))` };
          wsL.getCell(`P${r}`).value = { formula: `IF(L${r}="No","Missing a signed contract instore",IF(N${r}="","",IF(TODAY()-N${r}>14,"Overdue: More than 2 weeks",IF(TODAY()-N${r}>0,"Overdue: Less than 2 weeks","Within Timeframe"))))` };
          wsL.getCell(`Q${r}`).value = { formula: `IFERROR(XLOOKUP(P${r},'Data Validation'!$A:$A,'Data Validation'!$C:$C,""),"")` };
          wsL.getCell(`Q${r}`).alignment = { wrapText: true };
        }
      }

      const fileBase = (elFileName.value || "Loan Audit");
      const buffer = await wb.xlsx.writeBuffer();
      const blob = new Blob([buffer], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = `${fileBase}.xlsx`; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    } catch (err){
      console.error(err);
      elExportError.textContent = "Export failed. If this persists, try Chrome/Edge desktop and ensure file is opened from disk.";
      elExportError.classList.remove("hidden");
    }
  });
})();
</script>

<script>
// --------- QR Generator with tab-aware rendering ---------
(function(){
  const canvas = document.getElementById('qrCanvas');
  const ctx = canvas.getContext('2d');
  const input = document.getElementById('qrLinkInput');
  const errBox = document.getElementById('qrErr');

  let lastUrl = '';

  function cssPixelsToBacking(px){ return Math.max(1, Math.round(px * (window.devicePixelRatio || 1))); }
  function targetDisplaySize(){
    const shell = canvas.parentElement.getBoundingClientRect();
    const width = Math.round(shell.width || 0);
    // When hidden, width can be 0. Use a sensible fallback.
    return width > 0 ? Math.min(640, Math.max(240, width - 2)) : 360;
  }

  async function render(url){
    errBox.classList.add('hidden');
    if (!url) return;
    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;  // fixed regex

    if (!window.QRCode || typeof QRCode.toDataURL !== 'function'){
      errBox.classList.remove('hidden');
      errBox.textContent = 'QR library failed to load.';
      return;
    }

    const display = targetDisplaySize();
    const quiet = Math.round(display * 0.08);
    const qrSize = display - quiet*2;

    const w = cssPixelsToBacking(display);
    const h = cssPixelsToBacking(display);
    canvas.width = w; canvas.height = h;
    canvas.style.width = display + 'px';
    canvas.style.height = 'auto';

    const grad = ctx.createLinearGradient(0, 0, w, h);
    grad.addColorStop(0, '#046b30');
    grad.addColorStop(1, '#00c5a0');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, w, h);

    const q = cssPixelsToBacking(quiet);
    const s = cssPixelsToBacking(qrSize);
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(q, q, s, s);

    const qrPx = Math.max(180, Math.min(1200, s));
    const dataUrl = await QRCode.toDataURL(url, {
      errorCorrectionLevel:'H',
      margin: 1,
      width: qrPx,
      color:{ dark:'#000000', light:'#FFFFFF' }
    });

    const img = new Image();
    img.src = dataUrl;
    await img.decode();
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(img, q, q, s, s);
  }

  // Generate click
  document.getElementById('qrBtnGenerate').addEventListener('click', async () => {
    lastUrl = (input.value || '').trim();
    await render(lastUrl);
  });

  // Download
  document.getElementById('qrBtnDownload').addEventListener('click', () => {
    if (!canvas.width) return;
    const a = document.createElement('a');
    a.download = 'qr-code.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  });

  // Re-render when tab becomes visible
  window.addEventListener('qr-tab-shown', () => {
    lastUrl = (input.value || '').trim() || lastUrl;
    if (lastUrl) render(lastUrl);
  });

  // Also rerender on resize if already visible
  let resizeTimer;
  window.addEventListener('resize', () => {
    if (!lastUrl) return;
    // Only re-render if the QR tab is visible
    const visible = !document.getElementById('tab-qr').classList.contains('hidden');
    if (!visible) return;
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => render(lastUrl), 150);
  }, { passive:true });
})();
</script>
</body>
</html>
