<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>One NZ — Preston's Toolkit</title>
  <link rel="icon" href="one-nz-logo.jpg" type="image/jpeg">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (read) + ExcelJS (write) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <!-- QR lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- Custom Styles -->
  <link rel="stylesheet" href="style.css">
</head>

<body class="p-4 md:p-8 lg:p-12">

  <div class="max-w-7xl mx-auto space-y-8">

    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 animate-fade-in">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#046b30] to-[#00c5a0] flex items-center justify-center text-white shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
          </svg>
        </div>
        <div>
          <h1 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white">One NZ <span
              class="text-slate-400 font-light">|</span> Preston's Toolkit</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">Loan Audit & QR Generator</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <nav
          class="flex p-1 bg-white/50 dark:bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-200/60 dark:border-slate-700/60 shadow-sm">
          <button id="tabBtnLoan" class="tab-btn flex items-center gap-2 rounded-xl px-6 py-2.5 font-semibold text-sm"
            aria-selected="true">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
              <polyline points="14 2 14 8 20 8" />
              <path d="M16 13H8" />
              <path d="M16 17H8" />
              <path d="M10 9H8" />
            </svg>
            Loan Audit
          </button>
          <button id="tabBtnQR" class="tab-btn flex items-center gap-2 rounded-xl px-6 py-2.5 font-semibold text-sm"
            aria-selected="false">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="5" height="5" x="3" y="3" rx="1" />
              <rect width="5" height="5" x="16" y="3" rx="1" />
              <rect width="5" height="5" x="3" y="16" rx="1" />
              <path d="M21 16h-3a2 2 0 0 0-2 2v3" />
              <path d="M21 21v.01" />
              <path d="M12 7v3a2 2 0 0 1-2 2H7" />
              <path d="M3 12h.01" />
              <path d="M12 3h.01" />
              <path d="M12 16v.01" />
              <path d="M16 12h1" />
              <path d="M21 12v.01" />
              <path d="M12 21v-1" />
            </svg>
            QR Generator
          </button>
          <button id="tabBtnJesse" class="tab-btn flex items-center gap-2 rounded-xl px-6 py-2.5 font-semibold text-sm"
            aria-selected="false">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path
                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
            </svg>
            Jesse's Tools
          </button>
        </nav>

        <button id="darkModeToggle"
          class="p-2.5 rounded-xl bg-white/50 dark:bg-slate-800/50 backdrop-blur border border-slate-200/60 dark:border-slate-700/60 shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
          aria-label="Toggle dark mode">
          <svg id="iconLight" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="text-slate-600 dark:hidden">
            <circle cx="12" cy="12" r="4" />
            <path d="M12 2v2" />
            <path d="M12 20v2" />
            <path d="m4.93 4.93 1.41 1.41" />
            <path d="m17.66 17.66 1.41 1.41" />
            <path d="M2 12h2" />
            <path d="M20 12h2" />
            <path d="m6.34 17.66-1.41 1.41" />
            <path d="m19.07 4.93-1.41 1.41" />
          </svg>
          <svg id="iconDark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="text-slate-300 hidden dark:block">
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
          </svg>
        </button>
      </div>
    </header>

    <main class="relative min-h-[600px]">
      <!-- Loan Audit Tab -->
      <section id="tab-loan" class="space-y-6 animate-fade-in">

        <!-- Step 1: Upload -->
        <div class="card p-6 md:p-8 relative z-10">
          <div class="flex items-center gap-3 mb-6">
            <div
              class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
              1</div>
            <div class="flex items-center gap-2">
              <h2 class="text-xl font-bold text-slate-800">Upload Serial Report</h2>
              <div class="relative group">
                <button class="text-slate-400 hover:text-[#00c5a0] transition-colors cursor-help" aria-label="Help">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                    <path d="M12 17h.01" />
                  </svg>
                </button>
                <div
                  class="absolute left-0 top-full mt-2 w-72 bg-white rounded-xl shadow-xl border border-slate-100 p-4 z-20 hidden group-hover:block animate-fade-in">
                  <h4 class="font-bold text-slate-800 mb-2 text-sm">How to Get a Loan Serial Enquiry Report</h4>
                  <ol class="list-decimal pl-4 text-xs text-slate-600 space-y-2">
                    <li>Log in to Pronto.</li>
                    <li>Click <strong>Loans and Repairs</strong> &rarr; <strong>Serial Enquiry</strong>.</li>
                    <li>At the top, select your warehouse (Z + Store Name).</li>
                    <li><strong>Export the report:</strong>
                      <ul class="list-disc pl-4 mt-1 space-y-1 text-slate-500">
                        <li><em>Installed:</em> Right-click tab &rarr; Export Data.</li>
                        <li><em>Web:</em> Settings (cog) &rarr; Export Data.</li>
                      </ul>
                    </li>
                  </ol>
                </div>
              </div>
            </div>
          </div>

          <div
            class="flex flex-col md:flex-row gap-4 items-start md:items-center bg-slate-50/50 p-4 rounded-xl border border-slate-100">
            <input id="fileInput" type="file"
              class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-[#00c5a0]/10 file:text-[#046b30] hover:file:bg-[#00c5a0]/20 transition-all" />
          </div>

          <!-- KPIs -->
          <div id="kpis" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 hidden animate-slide-in">
            <div
              class="bg-emerald-50/50 border border-emerald-100 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
              <div class="text-xs font-semibold text-emerald-600 uppercase tracking-wider mb-1">Available</div>
              <div id="kpiAvailable" class="text-3xl font-bold text-emerald-700">0</div>
            </div>
            <div
              class="bg-blue-50/50 border border-blue-100 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
              <div class="text-xs font-semibold text-blue-600 uppercase tracking-wider mb-1">Allocated</div>
              <div id="kpiAllocated" class="text-3xl font-bold text-blue-700">0</div>
            </div>
            <div
              class="bg-purple-50/50 border border-purple-100 rounded-2xl p-4 flex flex-col items-center justify-center text-center">
              <div class="text-xs font-semibold text-purple-600 uppercase tracking-wider mb-1">Scanned (Unique)</div>
              <div id="kpiScanned" class="text-3xl font-bold text-purple-700">0</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Scan -->
        <div class="card p-6 md:p-8 delay-100">
          <div class="flex items-center gap-3 mb-6">
            <div
              class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
              2</div>
            <h2 class="text-xl font-bold text-slate-800">Scan Devices In-Store</h2>
          </div>

          <div class="space-y-4">
            <label class="text-sm font-medium text-slate-600 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 7V5a2 2 0 0 1 2-2h2" />
                <path d="M17 3h2a2 2 0 0 1 2 2v2" />
                <path d="M21 17v2a2 2 0 0 1-2 2h-2" />
                <path d="M7 21H5a2 2 0 0 1-2-2v-2" />
              </svg>
              Use your USB barcode scanner (auto-add on Enter/Tab)
            </label>
            <div class="flex items-center gap-3">
              <input id="manualSerial" autofocus placeholder="Click here and start scanning..."
                class="flex-1 border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-[#00c5a0]/20 transition-shadow" />
              <button id="btnAddSerial" class="btn-primary rounded-xl px-6 py-3 font-semibold">Add</button>
            </div>

            <div
              class="flex items-center justify-between text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100">
              <span>Available marked in-store:</span>
              <strong id="cntAvailInStore" class="text-lg text-[#046b30]">0</strong>
            </div>

            <div id="unknownBox" class="mt-4 hidden bg-red-50 border border-red-100 rounded-xl p-4 animate-slide-in">
              <div class="text-sm font-bold text-red-700 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="8" x2="12" y2="12" />
                  <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
                Unknown Serials
              </div>
              <ul id="unknownList" class="text-sm list-disc pl-5 text-red-600 space-y-1"></ul>
            </div>
          </div>
        </div>

        <!-- Step 3: Available Table -->
        <div class="card p-6 md:p-8 delay-200">
          <div class="flex items-center gap-3 mb-6">
            <div
              class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
              3</div>
            <h2 class="text-xl font-bold text-slate-800">Available — Confirm Quality & Comments</h2>
          </div>

          <div class="table-container">
            <div class="overflow-x-auto">
              <table id="tblAvailable" class="min-w-full text-sm">
                <thead>
                  <tr>
                    <th>Serial</th>
                    <th>Item</th>
                    <th>In Store</th>
                    <th>Condition</th>
                    <th>Action</th>
                    <th>Comments</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <p id="availNote" class="text-xs text-slate-500 mt-3 hidden italic">Showing first 400 rows. Export includes
            all rows.</p>
        </div>

        <!-- Step 4: Allocated Table -->
        <div class="card p-6 md:p-8 delay-300">
          <div class="flex items-center gap-3 mb-6">
            <div
              class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
              4</div>
            <h2 class="text-xl font-bold text-slate-800">Allocated — Contracts & Return Dates</h2>
          </div>

          <div class="table-container">
            <div class="overflow-x-auto">
              <table id="tblAllocated" class="min-w-full text-sm">
                <thead>
                  <tr>
                    <th>Serial</th>
                    <th>Item</th>
                    <th>Signed Contract</th>
                    <th>Due Date</th>
                    <th>Status (Auto)</th>
                    <th>Overdue Actions (Auto)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <p id="allocNote" class="text-xs text-slate-500 mt-3 hidden italic">Showing first 400 rows. Export includes
            all rows.</p>
        </div>

        <!-- Export Section -->
        <div class="card p-6 md:p-8">
          <div class="flex flex-col md:flex-row items-center gap-4">
            <div class="flex-1 w-full">
              <label class="block text-sm font-medium text-slate-700 mb-1">Export Filename</label>
              <input id="fileName" placeholder="e.g. Loan Audit Nov 2023" class="w-full px-4 py-2.5" />
            </div>
            <button id="btnExport"
              class="w-full md:w-auto btn-primary rounded-xl px-8 py-2.5 font-bold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Export Excel (.xlsx)
            </button>
          </div>
          <p class="text-xs text-slate-500 mt-3">Includes: <em>Paste Loan Report</em>, <em>Scan Available</em>,
            <em>Available</em>, <em>Allocated</em>, and <em>Data Validation</em> sheets.
          </p>
          <p id="exportError" class="text-sm text-red-600 mt-2 hidden bg-red-50 p-2 rounded border border-red-100"></p>
        </div>

        <!-- SharePoint Link -->
        <div class="card p-6 md:p-8 bg-slate-50/80 flex flex-col md:flex-row items-center justify-between gap-6">
          <div>
            <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
                <path d="M12 12v9" />
                <path d="m16 16-4-4-4 4" />
              </svg>
              Upload to SharePoint
            </h3>
            <p class="text-slate-600 text-sm">Finished your audit? Upload the exported Excel file to the Loan Phone
              Audits folder.</p>
          </div>
          <a href="https://ahunga.sharepoint.com/:f:/r/sites/RetailResourcesFolder/Shared%20Documents/General/Loan%20Phone%20Audits?csf=1&web=1&e=dEQIKg"
            target="_blank" rel="noopener noreferrer"
            class="btn-primary rounded-xl px-6 py-3 font-bold text-white shadow-md flex items-center gap-2 hover:scale-105 transition-transform">
            Open Folder
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
              <polyline points="15 3 21 3 21 9" />
              <line x1="10" y1="14" x2="21" y2="3" />
            </svg>
          </a>
        </div>
      </section>

      <!-- QR Generator Tab -->
      <section id="tab-qr" class="hidden animate-fade-in max-w-3xl mx-auto">
        <div class="card p-8 text-center">
          <div class="mb-8">
            <div
              class="w-16 h-16 bg-gradient-to-br from-[#046b30] to-[#00c5a0] rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="5" height="5" x="3" y="3" rx="1" />
                <rect width="5" height="5" x="16" y="3" rx="1" />
                <rect width="5" height="5" x="3" y="16" rx="1" />
                <path d="M21 16h-3a2 2 0 0 0-2 2v3" />
                <path d="M21 21v.01" />
                <path d="M12 7v3a2 2 0 0 1-2 2H7" />
                <path d="M3 12h.01" />
                <path d="M12 3h.01" />
                <path d="M12 16v.01" />
                <path d="M16 12h1" />
                <path d="M21 12v.01" />
                <path d="M12 21v-1" />
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-900">QR Code Generator</h2>
            <p class="text-slate-500 mt-2">Create branded QR codes instantly.</p>
          </div>

          <div class="space-y-6">
            <div class="flex flex-col sm:flex-row gap-3 items-stretch">
              <input id="qrLinkInput" type="text" placeholder="https://www.one.nz" value="https://www.one.nz"
                inputmode="url" class="flex-1 min-w-[240px] px-4 py-3 text-lg" />
              <button id="qrBtnGenerate" class="btn-primary rounded-xl px-8 py-3 font-bold text-white shadow-md">
                Generate
              </button>
            </div>

            <div id="qrErr"
              class="hidden text-red-700 bg-red-50 border border-red-200 rounded-xl px-4 py-3 text-sm font-medium animate-slide-in">
            </div>

            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-inner inline-block">
              <div class="rounded-xl overflow-hidden bg-white">
                <canvas id="qrCanvas"
                  style="display:block; width:100%; height:auto; max-width: 400px; margin: 0 auto;"></canvas>
              </div>
            </div>

            <div>
              <button id="qrBtnDownload"
                class="btn-secondary rounded-xl px-6 py-2.5 font-semibold text-sm flex items-center gap-2 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Download PNG
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Jesse's Tools Tab -->
      <section id="tab-jesse" class="hidden animate-fade-in space-y-6">
        <!-- Sub-navigation -->
        <div class="flex flex-wrap gap-2 justify-center mb-8">
          <button id="subBtnSim" class="btn-secondary rounded-xl px-6 py-2 font-medium text-sm active-sub-tab">SIM
            Swap</button>
          <button id="subBtnSr" class="btn-secondary rounded-xl px-6 py-2 font-medium text-sm">SR Template</button>
          <button id="subBtnKpi" class="btn-secondary rounded-xl px-6 py-2 font-medium text-sm">KPI Report</button>
        </div>

        <!-- SIM Swap Tool -->
        <div id="tool-sim" class="card p-6 md:p-8 max-w-4xl mx-auto">
          <h2 class="text-2xl font-bold text-slate-800 mb-6">SIM Swap Template Maker</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                <input type="text" id="simName" class="w-full px-4 py-2.5" oninput="simUpdate()">
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Contact Person</label>
                <div class="flex gap-4">
                  <label class="flex items-center gap-2 text-sm text-slate-600">
                    <input type="radio" name="simContact" value="accholder" onchange="simUpdate()" checked> Account
                    Holder
                  </label>
                  <label class="flex items-center gap-2 text-sm text-slate-600">
                    <input type="radio" name="simContact" value="authcontact" onchange="simUpdate()"> Authorised Contact
                  </label>
                </div>
              </div>

              <div id="simContactedRow" class="hidden">
                <label class="flex items-center gap-2 text-sm text-slate-600">
                  <input type="checkbox" id="simAhContacted" onchange="simUpdate()"> Account Holder Contacted
                </label>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">ID Type</label>
                <select id="simIdType" class="w-full px-4 py-2.5" onchange="simUpdate()">
                  <option value="" disabled selected>- Select ID -</option>
                  <option value="nzdl">NZ Drivers Licence</option>
                  <option value="nzpp">NZ Passport</option>
                  <option value="auspp">Australian Passport</option>
                  <option value="otherpp">Overseas Passport</option>
                  <option value="nzbc">NZ Birth Certificate & Bank Statement</option>
                  <option value="coi">Certificate of Identity</option>
                  <option value="kac">Kiwi Access Card & Bank Statement</option>
                  <option value="18p">18+ Card & Bank Statement</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">ID'd By</label>
                <div class="flex gap-4">
                  <label class="flex items-center gap-2 text-sm text-slate-600">
                    <input type="radio" name="simIdBy" value="pin" onchange="simUpdate()"> PIN
                  </label>
                  <label class="flex items-center gap-2 text-sm text-slate-600">
                    <input type="radio" name="simIdBy" value="secq" onchange="simUpdate()"> Security Qs
                  </label>
                  <label class="flex items-center gap-2 text-sm text-slate-600">
                    <input type="radio" name="simIdBy" value="otp" onchange="simUpdate()"> OTP (Prepay)
                  </label>
                </div>
              </div>

              <div id="simSecQs" class="hidden space-y-3 p-4 bg-slate-50 rounded-xl border border-slate-100">
                <div class="flex gap-4 mb-2">
                  <label class="flex items-center gap-2 text-xs font-bold text-slate-700">
                    <input type="radio" name="simQType" value="oa" onchange="simUpdateQs()"> On Account
                  </label>
                  <label class="flex items-center gap-2 text-xs font-bold text-slate-700">
                    <input type="radio" name="simQType" value="pp" onchange="simUpdateQs()"> Prepay
                  </label>
                </div>
                <div id="simQsList" class="space-y-2 text-sm text-slate-600">
                  <!-- Questions injected by JS -->
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Swap Reason</label>
                <input type="text" id="simReason" class="w-full px-4 py-2.5" oninput="simUpdate()">
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Approved By</label>
                <input type="text" id="simApprover" class="w-full px-4 py-2.5" oninput="simUpdate()">
              </div>
            </div>

            <div class="flex flex-col h-full">
              <label class="block text-sm font-medium text-slate-700 mb-1">Generated Template</label>
              <textarea id="simTemplate" readonly
                class="flex-1 w-full p-4 rounded-xl border border-slate-200 bg-slate-50 font-sans text-sm resize-none focus:ring-2 focus:ring-[#00c5a0]/20"
                rows="12"></textarea>
              <div class="flex items-center justify-between mt-3">
                <div class="text-xs text-slate-500">
                  <span id="simCharCount">0</span>/250 chars <span id="simSecCount" class="text-red-500"></span>
                </div>
                <button id="simBtnCopy"
                  class="btn-primary rounded-xl px-6 py-2 text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
                  Copy to Clipboard
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- SR Template Tool -->
        <div id="tool-sr" class="card p-6 md:p-8 max-w-4xl mx-auto hidden">
          <h2 class="text-2xl font-bold text-slate-800 mb-6">Service Request (Credit) Template</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Customer Number</label>
                <input type="text" id="srCxNum" class="w-full px-4 py-2.5" oninput="srUpdate()">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Customer Name</label>
                <input type="text" id="srCxName" class="w-full px-4 py-2.5" oninput="srUpdate()">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Complaint Ref Number</label>
                <input type="text" id="srRefNum" class="w-full px-4 py-2.5" oninput="srUpdate()">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Total Amount to Credit</label>
                <input type="text" id="srAmt" class="w-full px-4 py-2.5" oninput="srUpdate()">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Breakdown / Computation</label>
                <input type="text" id="srBreakdown" class="w-full px-4 py-2.5" oninput="srUpdate()">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Reason for Credit</label>
                <input type="text" id="srReason" class="w-full px-4 py-2.5" oninput="srUpdate()">
              </div>
            </div>

            <div class="flex flex-col h-full">
              <label class="block text-sm font-medium text-slate-700 mb-1">Generated Template</label>
              <textarea id="srTemplate" readonly
                class="flex-1 w-full p-4 rounded-xl border border-slate-200 bg-slate-50 font-sans text-sm resize-none focus:ring-2 focus:ring-[#00c5a0]/20"
                rows="12"></textarea>
              <div class="flex items-center justify-between mt-3">
                <div class="text-xs text-slate-500">
                  <span id="srCharCount">0</span>/250 chars
                </div>
                <button id="srBtnCopy" class="btn-primary rounded-xl px-6 py-2 text-sm font-bold">
                  Copy to Clipboard
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- KPI Report Tool -->
        <div id="tool-kpi" class="card p-6 md:p-8 hidden">
          <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
            <h2 class="text-2xl font-bold text-slate-800">KPI Tracker Report</h2>
            <div class="flex gap-3">
              <div class="relative">
                <input type="file" id="kpiInput" accept=".tsv, .csv"
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                <button class="btn-secondary rounded-xl px-6 py-2.5 font-semibold text-sm flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                  </svg>
                  Upload Sales Report
                </button>
              </div>
            </div>
          </div>

          <div id="kpiCapture" class="bg-white p-4 rounded-xl overflow-hidden">
            <table id="kpiTable" class="w-full text-sm text-center border-collapse rounded-xl overflow-hidden"
              style="border-radius: 1rem;">
              <!-- Generated by JS -->
            </table>
            <p id="kpiCopyright" class="text-center text-xs text-slate-400 mt-4 hidden">Jesse's Toolkit v2.1</p>
          </div>
        </div>
      </section>
    </main>

    <footer class="text-center text-slate-400 text-sm py-8">
      <p>Preston's Toolkit. Internal Use Only.</p>
    </footer>
  </div>

  <script>
    // --------- Dark Mode Toggle ---------
    (function () {
      const toggle = document.getElementById('darkModeToggle');
      const html = document.documentElement;

      // Check for saved preference or default to light mode
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        html.classList.add('dark');
      }

      toggle.addEventListener('click', () => {
        html.classList.toggle('dark');
        const isDark = html.classList.contains('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
    })();
  </script>

  <script>
    // --------- Tab Switcher ---------
    (function () {
      const btnLoan = document.getElementById('tabBtnLoan');
      const btnQR = document.getElementById('tabBtnQR');
      const btnJesse = document.getElementById('tabBtnJesse');
      const tabLoan = document.getElementById('tab-loan');
      const tabQR = document.getElementById('tab-qr');
      const tabJesse = document.getElementById('tab-jesse');

      function show(which) {
        tabLoan.classList.add('hidden');
        tabQR.classList.add('hidden');
        tabJesse.classList.add('hidden');

        btnLoan.setAttribute('aria-selected', 'false');
        btnQR.setAttribute('aria-selected', 'false');
        btnJesse.setAttribute('aria-selected', 'false');

        // Reset button styles for all tabs
        [btnLoan, btnQR, btnJesse].forEach(btn => {
          btn.classList.remove('text-white', 'dark:text-white');
          btn.classList.add('text-slate-600', 'dark:text-slate-300', 'hover:text-slate-900', 'dark:hover:text-white');
        });

        if (which === 'loan') {
          tabLoan.classList.remove('hidden');
          btnLoan.setAttribute('aria-selected', 'true');
          btnLoan.classList.add('text-white', 'dark:text-white');
          btnLoan.classList.remove('text-slate-600', 'dark:text-slate-300', 'hover:text-slate-900', 'dark:hover:text-white');
        } else if (which === 'qr') {
          tabQR.classList.remove('hidden');
          btnQR.setAttribute('aria-selected', 'true');
          btnQR.classList.add('text-white', 'dark:text-white');
          btnQR.classList.remove('text-slate-600', 'dark:text-slate-300', 'hover:text-slate-900', 'dark:hover:text-white');
          window.dispatchEvent(new CustomEvent('qr-tab-shown'));
        } else if (which === 'jesse') {
          tabJesse.classList.remove('hidden');
          btnJesse.setAttribute('aria-selected', 'true');
          btnJesse.classList.add('text-white', 'dark:text-white');
          btnJesse.classList.remove('text-slate-600', 'dark:text-slate-300', 'hover:text-slate-900', 'dark:hover:text-white');
        }
      }
      btnLoan.addEventListener('click', () => show('loan'));
      btnQR.addEventListener('click', () => show('qr'));
      btnJesse.addEventListener('click', () => show('jesse'));

      // Initial call to set correct styles based on default selected tab
      show('loan'); // Assuming 'loan' is the default selected tab
    })();
  </script>

  <script>
    // --------- Loan Audit logic ---------
    (function () {
      const toSerial = (v) => {
        if (v === null || v === undefined) return "";
        const s = String(v).trim();
        return s.replace(/\D/g, "");
      };

      const CONDITION_OPTIONS = [
        "Useable Condition",
        "Device is damaged/Unusable",
        "Not fit for purpose: Button phone, Data stick, Vodafone Branded device, iPhone 8 or lower",
        "Lost/Unable to Locate",
        "Pending Check"
      ];

      const CONDITION_TO_ACTION = {
        "Useable Condition": "Ensure device is reset, charged and ready to be loaned out",
        "Device is damaged/Unusable": "Follow process on K Hub article https://k-hub.vodafone.nz/pronto-how-to-charge-for-a-loan-phone",
        "Not fit for purpose: Button phone, Data stick, Vodafone Branded device, iPhone 8 or lower": "Raise request with Sales Ops to remove device from Fleet. Once removed, recycle as per BAU swap kit process",
        "Lost/Unable to Locate": "Try located device. If unable to find, Blocklist device and request Sales Operations to remove. Once confirmed, recycle as per BAU swap kit process.",
        "Pending Check": "Run Check"
      };

      const STATUS_ACTION_ROWS = [
        { status: "Within Timeframe", action: "No Action" },
        { status: "Overdue: Less than 2 weeks", action: "Contact customer to return device. Set clear timeframe of a week to have device returned or customer will be charged unless a new reasonable timeframe is agree by customer and Retail Lead. Return device and re issue new agreement with new timeframe as due date. Send customer email clearly stating new timeframe." },
        { status: "Overdue: More than 2 weeks", action: "Contact customer to return device. Set clear timeframe of a 3 days to have device returned or customer will be charged. If customer is not contactable, Blocklist device an await  3 days for the customer to return. If not returned, return device in pronto, raise request with sales operations to charge the customer and remove the device from your fleet." },
        { status: "Missing a signed contract instore", action: "Investigate why there is no contract with person who issued loan phone, provide appropriate action e.g., training/set expectations. Contact customer to arrange time to re visit store and sign contract." }
      ];

      let rawRows = [];
      let availableRows = [];
      let allocatedRows = [];
      let scanned = new Set();

      // Elements
      const elFile = document.getElementById("fileInput");
      // const elStats = document.getElementById("loadStats"); // Removed
      const elKpis = document.getElementById("kpis");
      const elKpiAvail = document.getElementById("kpiAvailable");
      const elKpiAlloc = document.getElementById("kpiAllocated");
      const elKpiScan = document.getElementById("kpiScanned");
      const elFileName = document.getElementById("fileName");
      const elBtnExport = document.getElementById("btnExport");
      const elTblAvailBody = document.querySelector("#tblAvailable tbody");
      const elTblAllocBody = document.querySelector("#tblAllocated tbody");
      const elAvailNote = document.getElementById("availNote");
      const elAllocNote = document.getElementById("allocNote");
      const elCntAvailInStore = document.getElementById("cntAvailInStore");
      const elUnknownBox = document.getElementById("unknownBox");
      const elUnknownList = document.getElementById("unknownList");
      const elManual = document.getElementById("manualSerial");
      const elAddSerial = document.getElementById("btnAddSerial");
      const elExportError = document.getElementById("exportError");

      // Removed: Validation Rules & Actions display logic (elements removed)

      // Load report
      elFile.addEventListener("change", async (e) => {
        try {
          const file = e.target.files?.[0];
          if (!file) return;

          if (typeof XLSX === 'undefined') {
            alert("Excel library not loaded. Please check your internet connection or refresh the page.");
            return;
          }

          // elFileName.value = file.name.replace(/\.[^.]+$/, "");
          const ab = await file.arrayBuffer();
          const wb = XLSX.read(ab, { type: "array" });

          const sheetName = wb.SheetNames.find(n => /paste/i.test(n)) || wb.SheetNames[0];
          const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: "" });

          rawRows = rows.filter((r) => {
            // Loose matching for headers to handle ODS or variations
            const keys = Object.keys(r).map(k => k.toLowerCase());
            const hasItem = keys.some(k => k.includes("item"));
            const hasSerial = keys.some(k => k.includes("serial"));

            // If we can't find exact headers, we might need to be smarter, but let's stick to original logic first
            // Original: String(r["Item"]).toLowerCase() === "item"
            // The ODS might have different column names?

            const maybeHdr = String(r["Item"] || "").toLowerCase() === "item" && String(r["Serial#"] || "").toLowerCase().includes("serial");
            const allBlank = Object.values(r).every(v => String(v).trim() === "");
            return !maybeHdr && !allBlank;
          }).map((r) => ({
            Item: r["Item"] ?? "",
            Serial: (String(r["Serial#"] || "")).trim(),
            SerialDigits: toSerial(r["Serial#"]),
            SerialDescription: r["Serial Description"] ?? r["SerialDescription"] ?? "",
            Warehouse: r["Warehouse"] ?? "",
            Name: r["Name"] ?? "",
            Availability: (r["Availability"] ?? "").toString().trim(),
            Contract: r["Contract#"] ?? "",
            Consign: r["Consign#"] ?? "",
            CS: r["CS"] ?? "",
            Repair: r["Repair#"] ?? "",
            RS: r["RS"] ?? "",
            Condition: r["Condition"] ?? "",
            Description: r["Description"] ?? "",
            Created: r["Created"] ?? ""
          }));

          availableRows = rawRows.filter(r => (r.Availability || "").toLowerCase() === "available")
            .map(r => ({ ...r, InStore: "Not Scanned", ConditionChoice: "Useable Condition", Comments: "" }));
          allocatedRows = rawRows.filter(r => (r.Availability || "").toLowerCase() !== "available")
            .map(r => ({ ...r, SignedContract: "Yes", DueDate: "", Status: "", OverdueActions: "", ConditionChoice: "Useable Condition" }));
          scanned.clear();
          elUnknownList.innerHTML = "";
          elUnknownBox.classList.add("hidden");

          elKpis.classList.remove("hidden");
          elKpiAvail.textContent = availableRows.length;
          elKpiAlloc.textContent = allocatedRows.length;
          elKpiScan.textContent = scanned.size;

          renderAvailable();
          renderAllocated();
          elBtnExport.disabled = false;
          // elStats.textContent = `Loaded ${rawRows.length} rows from “${sheetName}”.`;
          elManual.focus();
        } catch (err) {
          console.error(err);
          alert("Error loading file: " + err.message);
        }
      });

      function renderAvailable() {
        elTblAvailBody.innerHTML = "";
        const max = Math.min(400, availableRows.length);
        for (let i = 0; i < max; i++) {
          const r = availableRows[i];
          const tr = document.createElement("tr"); tr.className = "border-b hover:bg-slate-50";
          const tdS = document.createElement("td"); tdS.className = "p-3 mono font-medium"; tdS.textContent = r.SerialDigits || r.Serial;
          const tdI = document.createElement("td"); tdI.className = "p-3"; tdI.textContent = r.Item;
          const tdIS = document.createElement("td"); tdIS.className = "p-3";
          const selIS = document.createElement("select"); selIS.className = "border rounded-lg px-2 py-1.5 text-sm bg-white focus:ring-2 focus:ring-[#00c5a0]/20";
          ["Not Scanned", "Yes"].forEach(v => { const o = document.createElement("option"); o.value = v; o.textContent = v; if (r.InStore === v) o.selected = true; selIS.appendChild(o); });
          selIS.addEventListener("change", (e) => { r.InStore = e.target.value; updateCounts(); });
          tdIS.appendChild(selIS);

          const tdC = document.createElement("td"); tdC.className = "p-3";
          const selC = document.createElement("select"); selC.className = "border rounded-lg px-2 py-1.5 text-sm bg-white w-full min-w-[180px] focus:ring-2 focus:ring-[#00c5a0]/20";
          CONDITION_OPTIONS.forEach(opt => { const o = document.createElement("option"); o.value = opt; o.textContent = opt; if (r.ConditionChoice === opt) o.selected = true; selC.appendChild(o); });
          selC.addEventListener("change", (e) => { r.ConditionChoice = e.target.value; tdA.textContent = CONDITION_TO_ACTION[e.target.value] || ""; });
          tdC.appendChild(selC);

          const tdA = document.createElement("td"); tdA.className = "p-3 text-slate-600 text-xs"; tdA.textContent = CONDITION_TO_ACTION[r.ConditionChoice] || "";
          const tdCom = document.createElement("td"); tdCom.className = "p-3";
          const inp = document.createElement("input"); inp.className = "border rounded-lg px-2 py-1.5 text-sm w-full focus:ring-2 focus:ring-[#00c5a0]/20"; inp.value = r.Comments || "";
          inp.addEventListener("input", (e) => r.Comments = e.target.value);
          tdCom.appendChild(inp);

          tr.append(tdS, tdI, tdIS, tdC, tdA, tdCom);
          elTblAvailBody.appendChild(tr);
        }
        elAvailNote.classList.toggle("hidden", availableRows.length <= 400);
        updateCounts();
      }

      function getStatusAndAction(r) {
        let status = "Within Timeframe";
        if (r.SignedContract === "No") {
          status = "Missing a signed contract instore";
        } else if (r.DueDate) {
          const due = new Date(r.DueDate);
          const today = new Date();
          // Reset times to compare dates only
          due.setHours(0, 0, 0, 0);
          today.setHours(0, 0, 0, 0);

          const diffTime = today - due;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          if (diffDays > 14) status = "Overdue: More than 2 weeks";
          else if (diffDays > 0) status = "Overdue: Less than 2 weeks";
        }

        const actionObj = STATUS_ACTION_ROWS.find(x => x.status === status);
        const action = actionObj ? actionObj.action : "";
        return { status, action };
      }

      function renderAllocated() {
        elTblAllocBody.innerHTML = "";
        const max = Math.min(400, allocatedRows.length);
        for (let i = 0; i < max; i++) {
          const r = allocatedRows[i];
          const tr = document.createElement("tr"); tr.className = "border-b hover:bg-slate-50";
          const tdS = document.createElement("td"); tdS.className = "p-3 mono font-medium"; tdS.textContent = r.SerialDigits || r.Serial;
          const tdI = document.createElement("td"); tdI.className = "p-3"; tdI.textContent = r.Item;

          const tdSC = document.createElement("td"); tdSC.className = "p-3";
          const sel = document.createElement("select"); sel.className = "border rounded-lg px-2 py-1.5 text-sm bg-white focus:ring-2 focus:ring-[#00c5a0]/20";
          ["Yes", "No"].forEach(v => { const o = document.createElement("option"); o.value = v; o.textContent = v; if (r.SignedContract === v) o.selected = true; sel.appendChild(o); });
          sel.addEventListener("change", (e) => {
            r.SignedContract = e.target.value;
            const { status, action } = getStatusAndAction(r);
            tdStatus.textContent = status;
            tdAct.textContent = action;
          });
          tdSC.appendChild(sel);

          const tdDue = document.createElement("td"); tdDue.className = "p-3";
          const inp = document.createElement("input"); inp.type = "date"; inp.className = "border rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-[#00c5a0]/20"; inp.value = r.DueDate || "";
          inp.addEventListener("input", (e) => {
            r.DueDate = e.target.value;
            const { status, action } = getStatusAndAction(r);
            tdStatus.textContent = status;
            tdAct.textContent = action;
          });
          tdDue.appendChild(inp);

          const { status, action } = getStatusAndAction(r);
          const tdStatus = document.createElement("td"); tdStatus.className = "p-3 text-slate-600 text-xs font-medium"; tdStatus.textContent = status;
          const tdAct = document.createElement("td"); tdAct.className = "p-3 text-slate-500 text-xs"; tdAct.textContent = action;

          tr.append(tdS, tdI, tdSC, tdDue, tdStatus, tdAct);
          elTblAllocBody.appendChild(tr);
        }
        elAllocNote.classList.toggle("hidden", allocatedRows.length <= 400);
      }

      function updateCounts() {
        const availInStore = availableRows.filter(r => r.InStore === "Yes").length;
        elCntAvailInStore.textContent = String(availInStore);
        elKpiScan.textContent = String(scanned.size);
      }

      function addScan(value) {
        const s = toSerial(value);
        if (!s) return;
        scanned.add(s);
        const r = availableRows.find(x => (x.SerialDigits || x.Serial) === s);
        if (r) { r.InStore = "Yes"; updateCounts(); renderAvailable(); }
        else {
          const li = document.createElement("li"); li.textContent = s; elUnknownList.appendChild(li);
          elUnknownBox.classList.remove("hidden");
        }
      }

      elManual.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === "Tab") {
          e.preventDefault();
          addScan(e.target.value);
          e.target.value = "";
          e.target.focus();
        }
      });
      elAddSerial.addEventListener("click", () => {
        addScan(elManual.value);
        elManual.value = "";
        elManual.focus();
      });

      document.getElementById("btnExport").addEventListener("click", async () => {
        elExportError.classList.add("hidden");
        elExportError.textContent = "";
        try {
          if (!rawRows.length) {
            alert("Please upload your Pronto report first."); return;
          }
          const wb = new ExcelJS.Workbook();

          const dv = wb.addWorksheet("Data Validation");
          dv.addRow(["status", "Device condition", "Store actions"]);
          // STATUS_ACTION_ROWS is now in parent scope
          STATUS_ACTION_ROWS.forEach(r => dv.addRow([r.status, "", r.action]));
          const condToAction = {
            "Useable Condition": "Ensure device is reset, charged and ready to be loaned out",
            "Device is damaged/Unusable": "Follow process on K Hub article https://k-hub.vodafone.nz/pronto-how-to-charge-for-a-loan-phone",
            "Not fit for purpose: Button phone, Data stick, Vodafone Branded device, iPhone 8 or lower": "Raise request with Sales Ops to remove device from Fleet. Once removed, recycle as per BAU swap kit process",
            "Lost/Unable to Locate": "Try located device. If unable to find, Blocklist device and request Sales Operations to remove. Once confirmed, recycle as per BAU swap kit process.",
            "Pending Check": "Run Check"
          };
          CONDITION_OPTIONS.forEach(c => dv.addRow(["", c, (condToAction[c] || "")]));

          dv.getCell("E1").value = "Device condition list";
          CONDITION_OPTIONS.forEach((c, i) => dv.getCell(`E${i + 2}`).value = c);
          const condListRef = `'Data Validation'!$E$2:$E$${CONDITION_OPTIONS.length + 1}`;

          const raw = wb.addWorksheet("Paste Loan Report");
          raw.addRow(["Item", "Serial#", "Serial Description", "Warehouse", "Name", "Availability", "Contract#", "Consign#", "CS", "Repair#", "RS", "Condition", "Description", "Created"]);
          rawRows.forEach(r => raw.addRow([r.Item, r.SerialDigits || r.Serial, r.SerialDescription, r.Warehouse, r.Name, r.Availability, r.Contract, r.Consign, r.CS, r.Repair, r.RS, r.Condition, r.Description, r.Created]));

          const scan = wb.addWorksheet("Scan Available devices here");
          scan.addRow(["Scan Devices here", "Device Status", "Action"]);
          Array.from(scanned).forEach(s => {
            let status = "Unknown";
            let action = "";
            if (availableRows.some(r => (r.SerialDigits || r.Serial) === s)) {
              status = "Available";
            } else if (allocatedRows.some(r => (r.SerialDigits || r.Serial) === s)) {
              status = "Device in allocated state but physically in store";
              action = "Check for paperwork. Return device in Pronto.";
            }
            scan.addRow([s, status, action]);
          });

          const wsA = wb.addWorksheet("Available");
          wsA.addRow(["Item", "Serial#", "Serial Description", "Warehouse", "Name", "Availability", "Contract#", "Consign#", "Condition", "Description", "Created", "In Store", "Condition", "Action based on condition", "Comments"]);
          availableRows.forEach(r => wsA.addRow([r.Item, String(r.SerialDigits || r.Serial), r.SerialDescription, r.Warehouse, r.Name, "Available", r.Contract, r.Consign, r.Condition, r.Description, r.Created, r.InStore, r.ConditionChoice || "Useable Condition", "", r.Comments || ""]));
          const lastRowA = wsA.rowCount;
          if (lastRowA > 1) {
            wsA.dataValidations.add(`N2:N${lastRowA}`, { type: "list", allowBlank: true, formulae: [condListRef], showErrorMessage: true, errorStyle: "stop", errorTitle: "Invalid choice", error: "Pick a value from the dropdown." });
            for (let r = 2; r <= lastRowA; r++) {
              wsA.getCell(`O${r}`).value = { formula: `IFERROR(XLOOKUP(N${r},'Data Validation'!$B:$B,'Data Validation'!$C:$C,""),"")` };
              wsA.getCell(`O${r}`).alignment = { wrapText: true };
            }
          }

          const wsL = wb.addWorksheet("Allocated");
          wsL.addRow(["Item", "Serial#", "Serial Description", "Warehouse", "Name", "Availability", "Contract#", "Consign#", "Condition", "Description", "Created", "Signed contract", "Contract Actions", "Due Date", "Days overdue", "Status", "Overdue Actions"]);
          allocatedRows.forEach(r => wsL.addRow([r.Item, String(r.SerialDigits || r.Serial), r.SerialDescription, r.Warehouse, r.Name, r.Availability, r.Contract, r.Consign, r.Condition, r.Description, r.Created, r.SignedContract, "", r.DueDate || "", "", "", ""]));
          const lastRowL = wsL.rowCount;
          if (lastRowL > 1) {
            for (let r = 2; r <= lastRowL; r++) {
              wsL.getCell(`O${r}`).value = { formula: `IF(N${r}="","",MAX(0,TODAY()-N${r}))` };
              wsL.getCell(`P${r}`).value = { formula: `IF(L${r}="No","Missing a signed contract instore",IF(N${r}="","",IF(TODAY()-N${r}>14,"Overdue: More than 2 weeks",IF(TODAY()-N${r}>0,"Overdue: Less than 2 weeks","Within Timeframe"))))` };
              wsL.getCell(`Q${r}`).value = { formula: `IFERROR(XLOOKUP(P${r},'Data Validation'!$A:$A,'Data Validation'!$C:$C,""),"")` };
              wsL.getCell(`Q${r}`).alignment = { wrapText: true };
            }
          }

          const fileBase = (elFileName.value || "Loan Audit");
          const buffer = await wb.xlsx.writeBuffer();
          const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a"); a.href = url; a.download = `${fileBase}.xlsx`; document.body.appendChild(a); a.click(); a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
        } catch (err) {
          console.error(err);
          elExportError.textContent = "Export failed. If this persists, try Chrome/Edge desktop and ensure file is opened from disk.";
          elExportError.classList.remove("hidden");
        }
      });
    })();
  </script>

  <script>
    // --------- QR Generator ---------
    (function () {
      const canvas = document.getElementById('qrCanvas');
      const ctx = canvas.getContext('2d');
      const input = document.getElementById('qrLinkInput');
      const errBox = document.getElementById('qrErr');

      let lastUrl = '';

      function cssPixelsToBacking(px) { return Math.max(1, Math.round(px * (window.devicePixelRatio || 1))); }
      function targetDisplaySize() {
        const shell = canvas.parentElement.getBoundingClientRect();
        const width = Math.round(shell.width || 0);
        return width > 0 ? Math.min(640, Math.max(240, width - 2)) : 360;
      }

      async function render(url) {
        errBox.classList.add('hidden');
        if (!url) return;
        if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

        if (!window.QRCode || typeof QRCode.create !== 'function') {
          if (typeof QRCode.toDataURL !== 'function') {
            errBox.classList.remove('hidden');
            errBox.textContent = 'QR library failed to load.';
            return;
          }
        }

        try {
          const qr = QRCode.create(url, { errorCorrectionLevel: 'H' });
          const modules = qr.modules;
          const size = modules.size;

          const display = targetDisplaySize();
          const margin = 2;
          const cellSize = display / (size + margin * 2);

          const w = cssPixelsToBacking(display);
          const h = cssPixelsToBacking(display);
          canvas.width = w; canvas.height = h;
          canvas.style.width = display + 'px';
          canvas.style.height = 'auto';

          ctx.scale(w / display, h / display);

          // --- 1. Liquid Glass Background ---
          // Create a mesh-like gradient background
          const bgGrad = ctx.createLinearGradient(0, 0, display, display);
          bgGrad.addColorStop(0, '#f0fdf4'); // Very light green
          bgGrad.addColorStop(0.5, '#ffffff');
          bgGrad.addColorStop(1, '#ecfdf5'); // Minty white

          ctx.fillStyle = bgGrad;
          ctx.fillRect(0, 0, display, display);

          // Add soft "liquid" blobs
          const drawBlob = (x, y, r, color) => {
            ctx.beginPath();
            const g = ctx.createRadialGradient(x, y, 0, x, y, r);
            g.addColorStop(0, color);
            g.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = g;
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
          };

          // Subtle background blobs for depth
          drawBlob(display * 0.2, display * 0.2, display * 0.4, 'rgba(4, 107, 48, 0.05)');
          drawBlob(display * 0.8, display * 0.8, display * 0.4, 'rgba(0, 197, 160, 0.08)');
          drawBlob(display * 0.8, display * 0.2, display * 0.3, 'rgba(4, 107, 48, 0.03)');

          // --- 2. Glossy Modules ---
          // Gradient for the modules themselves
          const modGrad = ctx.createLinearGradient(0, 0, display, display);
          modGrad.addColorStop(0, '#046b30');
          modGrad.addColorStop(1, '#00c5a0');

          const offset = margin * cellSize;

          // Helper: Finder Pattern Areas
          const isFinder = (c, r) => {
            return (r < 7 && c < 7) || (r < 7 && c >= size - 7) || (r >= size - 7 && c < 7);
          };

          // Helper: Center Logo Area (exclude 5x5 area in middle)
          const centerStart = Math.floor(size / 2) - 2;
          const centerEnd = Math.floor(size / 2) + 2;
          const isCenter = (c, r) => c >= centerStart && c <= centerEnd && r >= centerStart && r <= centerEnd;

          ctx.fillStyle = modGrad;

          // Add a subtle drop shadow to modules for "floating" effect
          ctx.shadowColor = "rgba(0, 197, 160, 0.2)";
          ctx.shadowBlur = 4;
          ctx.shadowOffsetY = 2;

          for (let r = 0; r < size; r++) {
            for (let c = 0; c < size; c++) {
              if (modules.get(c, r) && !isFinder(c, r) && !isCenter(c, r)) {
                const x = offset + c * cellSize;
                const y = offset + r * cellSize;

                // Draw "Liquid" Droplet (Rounded Rect)
                const pad = cellSize * 0.1;
                const modSize = cellSize - pad * 2;
                const radius = modSize * 0.4; // Very round

                ctx.beginPath();
                ctx.roundRect(x + pad, y + pad, modSize, modSize, radius);
                ctx.fill();

                // Add a tiny white highlight for gloss
                ctx.save();
                ctx.fillStyle = "rgba(255,255,255,0.3)";
                ctx.beginPath();
                ctx.arc(x + cellSize * 0.35, y + cellSize * 0.35, modSize * 0.15, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
              }
            }
          }

          // Reset Shadow
          ctx.shadowColor = "transparent";
          ctx.shadowBlur = 0;
          ctx.shadowOffsetY = 0;

          // --- 3. Custom Finder Patterns (Liquid Style) ---
          const drawFinder = (cx, cy) => {
            const outerSize = cellSize * 7;
            const x = offset + cx * cellSize;
            const y = offset + cy * cellSize;

            // Outer Ring (Gradient Stroke)
            const ringGrad = ctx.createLinearGradient(x, y, x + outerSize, y + outerSize);
            ringGrad.addColorStop(0, '#046b30');
            ringGrad.addColorStop(1, '#00c5a0');

            ctx.strokeStyle = ringGrad;
            ctx.lineWidth = cellSize;
            ctx.lineCap = "round";
            ctx.beginPath();
            const rOuter = cellSize * 2;
            ctx.roundRect(x + cellSize / 2, y + cellSize / 2, outerSize - cellSize, outerSize - cellSize, rOuter);
            ctx.stroke();

            // Inner Dot (Liquid Sphere)
            ctx.fillStyle = ringGrad;
            const innerSize = cellSize * 3;
            const centerOffset = (outerSize - innerSize) / 2;
            const ix = x + centerOffset;
            const iy = y + centerOffset;

            ctx.beginPath();
            ctx.roundRect(ix, iy, innerSize, innerSize, innerSize * 0.4);
            ctx.fill();

            // Gloss on inner dot
            ctx.fillStyle = "rgba(255,255,255,0.4)";
            ctx.beginPath();
            ctx.arc(ix + innerSize * 0.3, iy + innerSize * 0.3, innerSize * 0.15, 0, Math.PI * 2);
            ctx.fill();
          };

          drawFinder(0, 0); // TL
          drawFinder(size - 7, 0); // TR
          drawFinder(0, size - 7); // BL

          // --- 4. Seamless Glass Logo ---
          const centerPx = display / 2;
          const logoSize = display * 0.22;

          // Glass Container (Blurry, semi-transparent)
          ctx.save();
          ctx.shadowColor = "rgba(0,0,0,0.1)";
          ctx.shadowBlur = 15;
          ctx.shadowOffsetY = 5;

          ctx.beginPath();
          ctx.arc(centerPx, centerPx, logoSize / 2 + 4, 0, Math.PI * 2);
          ctx.fillStyle = "rgba(255, 255, 255, 0.9)"; // More opaque for image backing
          ctx.fill();
          ctx.restore();

          // Draw Image Logo
          // We need to load the image first. 
          // Note: In a real app, we'd preload this. Here we await it.
          const logoImg = new Image();
          logoImg.src = "one-nz-logo.jpg";

          // Wrap image loading in a promise
          await new Promise((resolve, reject) => {
            if (logoImg.complete) resolve();
            logoImg.onload = resolve;
            logoImg.onerror = () => {
              console.warn("Logo failed to load, skipping");
              resolve(); // Continue without logo
            };
          });

          if (logoImg.complete && logoImg.naturalWidth > 0) {
            ctx.save();
            // Clip to circle
            ctx.beginPath();
            ctx.arc(centerPx, centerPx, logoSize / 2, 0, Math.PI * 2);
            ctx.clip();

            // Draw image centered and covering the area
            ctx.drawImage(logoImg, centerPx - logoSize / 2, centerPx - logoSize / 2, logoSize, logoSize);
            ctx.restore();

            // Add a glossy shine over the logo
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerPx, centerPx, logoSize / 2, 0, Math.PI * 2);
            const shine = ctx.createLinearGradient(centerPx - logoSize, centerPx - logoSize, centerPx + logoSize, centerPx + logoSize);
            shine.addColorStop(0, "rgba(255,255,255,0.1)");
            shine.addColorStop(0.5, "rgba(255,255,255,0)");
            shine.addColorStop(1, "rgba(255,255,255,0.1)");
            ctx.fillStyle = shine;
            ctx.fill();
            ctx.restore();
          }

        } catch (e) {
          console.error(e);
          const qrPx = Math.max(180, Math.min(1200, targetDisplaySize()));
          const dataUrl = await QRCode.toDataURL(url, { errorCorrectionLevel: 'H', margin: 1, width: qrPx });
          const img = new Image();
          img.src = dataUrl;
          await img.decode();
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }
      }

      document.getElementById('qrBtnGenerate').addEventListener('click', async () => {
        lastUrl = (input.value || '').trim();
        await render(lastUrl);
      });

      document.getElementById('qrBtnDownload').addEventListener('click', () => {
        if (!canvas.width) return;
        const a = document.createElement('a');
        a.download = 'qr-code.png';
        a.href = canvas.toDataURL('image/png');
        a.click();
      });

      window.addEventListener('qr-tab-shown', () => {
        lastUrl = (input.value || '').trim() || lastUrl;
        if (lastUrl) render(lastUrl);
      });

      let resizeTimer;
      window.addEventListener('resize', () => {
        if (!lastUrl) return;
        const visible = !document.getElementById('tab-qr').classList.contains('hidden');
        if (!visible) return;
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => render(lastUrl), 150);
      }, { passive: true });
    })();
  </script>
  <script>
    // --------- Jesse's Tools Logic ---------
    (function () {
      // --- Tabs ---
      const btnSim = document.getElementById('subBtnSim');
      const btnSr = document.getElementById('subBtnSr');
      const btnKpi = document.getElementById('subBtnKpi');
      const toolSim = document.getElementById('tool-sim');
      const toolSr = document.getElementById('tool-sr');
      const toolKpi = document.getElementById('tool-kpi');

      function showSubTab(which) {
        [btnSim, btnSr, btnKpi].forEach(b => {
          b.classList.remove('bg-emerald-600', 'text-white', 'border-transparent');
          b.classList.add('btn-secondary'); // Reset to secondary style
        });
        [toolSim, toolSr, toolKpi].forEach(t => t.classList.add('hidden'));

        if (which === 'sim') {
          toolSim.classList.remove('hidden');
          btnSim.classList.remove('btn-secondary');
          btnSim.classList.add('bg-emerald-600', 'text-white', 'border-transparent');
        } else if (which === 'sr') {
          toolSr.classList.remove('hidden');
          btnSr.classList.remove('btn-secondary');
          btnSr.classList.add('bg-emerald-600', 'text-white', 'border-transparent');
        } else if (which === 'kpi') {
          toolKpi.classList.remove('hidden');
          btnKpi.classList.remove('btn-secondary');
          btnKpi.classList.add('bg-emerald-600', 'text-white', 'border-transparent');
        }
      }

      btnSim.addEventListener('click', () => showSubTab('sim'));
      btnSr.addEventListener('click', () => showSubTab('sr'));
      btnKpi.addEventListener('click', () => showSubTab('kpi'));

      // Initialize sub-tab style
      showSubTab('sim');


      // --- SIM Swap Logic ---
      const simName = document.getElementById('simName');
      const simAhContacted = document.getElementById('simAhContacted');
      const simIdType = document.getElementById('simIdType');
      const simReason = document.getElementById('simReason');
      const simApprover = document.getElementById('simApprover');
      const simTemplate = document.getElementById('simTemplate');
      const simCharCount = document.getElementById('simCharCount');
      const simSecCount = document.getElementById('simSecCount');
      const simBtnCopy = document.getElementById('simBtnCopy');
      const simQsList = document.getElementById('simQsList');

      const OA_QS = [
        { text: "How long have you had this mobile number/connection?", value: "Tenure" },
        { text: "Can you tell me a number that you have called in the last 2 days and they have answered.", value: "Num called last 2 days" },
        { text: "What method do you usually use to pay your account?", value: "Payment Method" },
        { text: "What was the most recent payment amount on your account?", value: "Most recent payment on account" },
        { text: "When did you last call us and what did you discuss?", value: "Last call to One NZ/Details of Call" }
      ];
      const PP_QS = [
        { text: "When did you last top up your number and what was the top up value?", value: "Last topup date & value" },
        { text: "What are the last four digits of the credit card registered on your ‘My One NZ’ account?", value: "Last 4 Digits Credit Card" },
        { text: "What is your monthly bundle of minutes, txt’s and data?", value: "Monthly Bundle-Min/Data/Txt" },
        { text: "How long have you had this mobile number/connection?", value: "Tenure" },
        { text: "Can you tell me a number that you have called in the last 2 days and they have answered.", value: "Num called last 2 days" }
      ];

      window.simUpdate = function () {
        const contact = document.querySelector('input[name="simContact"]:checked').value;
        const idBy = document.querySelector('input[name="simIdBy"]:checked')?.value || "";

        // Toggle visibility
        document.getElementById('simContactedRow').classList.toggle('hidden', contact !== 'authcontact');
        document.getElementById('simSecQs').classList.toggle('hidden', idBy !== 'secq');

        // Build template
        let t = `Full name: ${simName.value}\n`;

        let cStr = contact === 'accholder' ? "Acc Holder" : "Auth Contact";
        if (contact === 'authcontact') {
          cStr += `\nAcc Holder Contacted: ${simAhContacted.checked ? 'Y' : 'N'}`;
        }
        t += `Acc Holder/Auth Contact: ${cStr}\n`;

        const idMap = {
          nzdl: "NZDL", nzpp: "NZ Passport", auspp: "Aus Passport", otherpp: "Overseas Passport",
          nzbc: "Birth cert & bank statement", coi: "Cert of identity", kac: "Kiwi Access & bank statement", "18p": "18+ & bank statement"
        };
        t += `ID Type: ${idMap[simIdType.value] || ""}\n`;

        let idbStr = "";
        if (idBy === 'pin') idbStr = "PIN";
        else if (idBy === 'otp') idbStr = "OTP";
        else if (idBy === 'secq') {
          const checkedQs = Array.from(document.querySelectorAll('input[name="simQCheck"]:checked')).map(c => c.value);
          idbStr = `Sec Qs\nQs asked: ${checkedQs.join(', ')}`;
        }
        t += `ID'd by: ${idbStr}\n`;
        t += `Swap reason: ${simReason.value}\n`;
        t += `Approved by: ${simApprover.value}`;

        simTemplate.value = t;
        simCharCount.textContent = t.length;

        // Validation
        let valid = simName.value && simIdType.value && idBy && simReason.value && simApprover.value;
        if (contact === 'authcontact' && !simAhContacted.checked) valid = false;

        if (idBy === 'secq') {
          const qCount = document.querySelectorAll('input[name="simQCheck"]:checked').length;
          simSecCount.textContent = ` | Qs: ${qCount}/2`;
          if (qCount < 2) valid = false;
        } else {
          simSecCount.textContent = "";
        }

        simBtnCopy.disabled = !valid;
      };

      window.simUpdateQs = function () {
        const type = document.querySelector('input[name="simQType"]:checked')?.value;
        simQsList.innerHTML = "";
        if (!type) return;

        const qs = type === 'oa' ? OA_QS : PP_QS;
        qs.forEach(q => {
          const div = document.createElement('div');
          div.className = "flex items-start gap-2";
          div.innerHTML = `<input type="checkbox" name="simQCheck" value="${q.value}" onchange="simUpdate()" class="mt-1"> <span>${q.text}</span>`;
          simQsList.appendChild(div);
        });
        simUpdate();
      };

      simBtnCopy.addEventListener('click', () => {
        navigator.clipboard.writeText(simTemplate.value);
        const original = simBtnCopy.textContent;
        simBtnCopy.textContent = "Copied!";
        setTimeout(() => simBtnCopy.textContent = original, 1500);
      });


      // --- SR Template Logic ---
      window.srUpdate = function () {
        const cxNum = document.getElementById('srCxNum').value;
        const cxName = document.getElementById('srCxName').value;
        const refNum = document.getElementById('srRefNum').value;
        const amt = document.getElementById('srAmt').value;
        const bd = document.getElementById('srBreakdown').value;
        const reason = document.getElementById('srReason').value;

        let t = `Customer number: ${cxNum}\nCustomer name: ${cxName}\n`;
        if (refNum) t += `Complaint reference number: ${refNum}\n`;
        t += `Total amount to be credited: ${amt}\n`;
        t += `Breakdown/computation with respective month of invoice and charge: ${bd}\n`;
        t += `Reason for credit: ${reason}`;

        document.getElementById('srTemplate').value = t;
        document.getElementById('srCharCount').textContent = t.length;
      };

      document.getElementById('srBtnCopy').addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('srTemplate').value);
        const btn = document.getElementById('srBtnCopy');
        const original = btn.textContent;
        btn.textContent = "Copied!";
        setTimeout(() => btn.textContent = original, 1500);
      });


      // --- KPI Report Logic ---
      const kpiInput = document.getElementById('kpiInput');
      const kpiTable = document.getElementById('kpiTable');
      const kpiBtnScreenshot = document.getElementById('kpiBtnScreenshot');

      const KPI_HEADERS = [
        { heading: "", sub: ["rep"] },
        { heading: "Legends", sub: ["coa", "boa", "cfab", "bfab", "oneup", "gm"] },
        { heading: "GP", sub: ["gp"] },
        { heading: "Connections", sub: ["p2p", "rs", "ict"] },
        { heading: "Other", sub: ["dev", "accs", "trend", "bills", "topup", "pp", "com"] }
      ];
      const KPI_COLS = {
        rep: "Rep", gp: "Gross Profit", gm: "Gen Merch", coa: "Con OA", cfab: "Con FAB",
        boa: "Bus OA", bfab: "Bus FAB", p2p: "P2P", rs: "Resigns", ict: "ICT",
        dev: "Devices", accs: "Accs", trend: "Trend", pp: "Prepay", oneup: "One Up",
        topup: "Top-ups", bills: "Bills", com: "Commission"
      };
      const KPI_COMMISSION = {
        dev: 0.05, gm: 0.1, pp: 2, oneup: 5, fbb: 13, fbbrs: 6.5, busifbb: 20, busifbbrs: 6.5,
        wbb: 13, wbbrs: 6.5, companion: 7.5, companionrs: 0, p2p: 3, edsmall: 4, edsmallrs: 1,
        edmedium: 7.5, edmediumrs: 1, edlarge: 12, edlargers: 5, oneplan: 20, oneplanrs: 7, tollfree: 10,
        webex: 10, multitxt: 15, saas: 5, mcd: 5, payg: 2, assets: 10, watch: 5
      };
      const DOLLAR_COLS = ["gp", "gm", "com"];
      let kpiSortCol = 'gp';
      let kpiProcessedData = {};
      let kpiSubHeadings = KPI_HEADERS.flatMap(h => h.sub);

      kpiInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const raw = readTSV(ev.target.result);
          processKpiData(raw);
          renderKpiTable();
        };
        reader.readAsText(file);
      });

      function readTSV(text) {
        const rows = text.split("\n").map(r => r.split("\t"));
        const headers = rows.shift();
        return rows.map(r => {
          let obj = {};
          r.forEach((cell, i) => obj[headers[i]] = cell.trimEnd());
          return obj;
        });
      }

      function processKpiData(data) {
        let report = {};
        data.forEach(row => {
          let rep = row['Order Rep Name'];
          let code = row['Item Code'];
          let rrp = parseFloat(row['Recommended Retail Price'] || 0);
          let gp = parseFloat(row['Shipped GP'] || 0);
          let qty = parseInt(row['Shipped Quantity'] || 0);

          if (!rep || rep === "Click N Collect") return;
          if (qty === 0 && rrp === 0) return;
          if (rrp !== 0 && qty > 0 && gp < 0) return; // Skip transfers/write-offs
          if ((code || "").includes("-NOADDON") || (code || "").includes("-ADD-VO")) return;

          if (rrp === 0 && !(row['Product Group'] || "").includes("Top Up")) qty *= -1;

          if (!report[rep]) {
            report[rep] = { rep };
            Object.keys(KPI_COLS).forEach(k => { if (k !== 'rep') report[rep][k] = 0; });
          }

          const pg = row['Product Group'];
          const r = report[rep];

          // Logic ported from jesse.html
          if (pg === 'ConsNC Voice Smart Data') { r.coa += qty; r.gp += gp * 5; r.com += gp; }
          else if (pg === 'ConsPP Voice Smart Data PPN') { r.p2p += qty; r.gp += gp * 5; r.com += gp; }
          else if (pg === 'ConsRS Voice Smart Data') { r.rs += qty; r.gp += gp * 5; r.com += gp; }
          else if (['BussNC Voice Smart Data', 'BussNC Bundle Add-on Bundle', 'BussNC Bundle IOT', 'BussNC Data MBB'].includes(pg)) { r.boa += qty; r.gp += gp * 5; r.com += gp; }
          else if (pg === 'BussPP Voice Smart Data PPN') { r.p2p += qty; r.gp += gp * 5; r.com += gp; }
          else if (['BussRS Data MBB', 'BussRS Voice Smart Data'].includes(pg)) { r.rs += qty; r.gp += gp * 5; r.com += gp; }
          else if (pg === 'ConsNC FAB HM BB') { r.cfab += qty; r.gp += gp * 5; r.com += gp; }
          else if (pg === 'ConsRS FAB HM BB') { r.rs += qty; r.gp += gp * 5; r.com += gp; }
          else if (pg === 'BussNC FAB WK BB') { r.bfab += qty; r.gp += gp * 5; r.com += gp; }
          else if (pg === 'BussRS FAB WK BB') { r.rs += qty; r.gp += gp * 5; r.com += gp; }
          else if (pg === 'BussNC ICT') { r.ict -= qty; r.com += gp; }
          else if (['Live HSDPA', 'Business HSDPA', 'Tablet'].includes(pg)) { r.dev += qty; r.gp += gp; }
          else if (pg === 'CST Device') { r.dev += qty; r.gp += gp; r.com += KPI_COMMISSION.dev * gp + KPI_COMMISSION.watch * qty; }
          else if (['CST Accessories', 'Adapters', 'Bluetooth Headset', 'Bundles', 'Cases', 'Chargers', 'Entertainment and Gaming', 'Holders/Cradles', 'Memory', 'Screen Protectors', 'Other'].includes(pg)) { r.accs += qty; r.gp += gp; r.gm += gp; r.com += KPI_COMMISSION.gm * gp; }
          else if (['Antivirus 1 Year Subscription', 'Antivirus 2 Year Subscription', 'Antivirus 3 Year Subscription', 'Antivirus - Prepay'].includes(pg)) { r.trend += qty; r.gp += gp; r.gm += gp; r.com += KPI_COMMISSION.gm * gp; }
          else if (pg === 'Prepay') { r.pp += qty; r.gp += gp; r.com += qty * KPI_COMMISSION.pp; }
          else if (pg === 'IFP Commission Line Group') {
            if (code === 'IFP-UPGRADEADD') { r.oneup += qty; r.com += qty * KPI_COMMISSION.oneup; }
            if (code === 'IFP-COMM') { r.gp += gp * 5; }
          }
          else if (['Prepay Mobile Top Up', 'Prepay Direct Top Up'].includes(pg)) { r.topup += qty; }
          else if (pg === 'Mobile On Account Bill Payment') { r.bills -= qty; }
          else if (pg === 'MDP') { r.gp += gp; }
        });
        kpiProcessedData = report;
      }

      function renderKpiTable() {
        kpiTable.innerHTML = "";
        if (Object.keys(kpiProcessedData).length === 0) return;

        // Sort
        let rows = Object.values(kpiProcessedData);
        rows.sort((a, b) => {
          if (kpiSortCol === 'rep') return a.rep.localeCompare(b.rep);
          return b[kpiSortCol] - a[kpiSortCol];
        });

        // Calculate Totals
        let totals = { rep: "Totals" };
        kpiSubHeadings.forEach(k => {
          if (k !== 'rep') {
            totals[k] = rows.reduce((sum, r) => sum + (r[k] || 0), 0);
          }
        });
        // Create Table Structure
        // Header 1 (Groups) - Glassmorphism effect
        const thead = document.createElement('thead');
        const tr1 = document.createElement('tr');
        tr1.className = "bg-white/60 dark:bg-slate-700/90 backdrop-blur-sm text-slate-700 dark:text-white text-sm uppercase tracking-wide border-b border-white/50 dark:border-slate-500/50 shadow-sm";
        tr1.style.backdropFilter = "blur(12px)";
        tr1.style.borderRadius = "1rem 1rem 0 0";
        KPI_HEADERS.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h.heading;
          th.colSpan = h.sub.length;
          th.className = "px-2 py-4 font-bold text-center border-r border-white/30 last:border-r-0";
          if (h.heading === "") {
            th.className = "px-2 py-4 bg-white/60 dark:bg-slate-700/90 backdrop-blur-sm border-r-0"; // Empty corner - no border
            th.style.backdropFilter = "blur(12px)";
          }
          tr1.appendChild(th);
        });
        thead.appendChild(tr1);

        // Header 2 (Columns) - Frosted glass effect
        const tr2 = document.createElement('tr');
        tr2.className = "bg-gradient-to-b from-white/80 to-white/60 dark:from-slate-600/90 dark:to-slate-700/90 backdrop-blur-md text-slate-800 dark:text-white text-sm font-bold border-b-2 border-emerald-200/50 dark:border-slate-500/50 shadow-sm";
        tr2.style.backdropFilter = "blur(16px)";
        kpiSubHeadings.forEach(k => {
          const th = document.createElement('th');
          th.textContent = KPI_COLS[k];
          th.className = "px-2 py-4 text-left cursor-pointer hover:bg-emerald-100/40 hover:shadow-inner transition-all duration-300 select-none border-r border-white/20 last:border-r-0 rounded-md";
          if (k === kpiSortCol) {
            th.classList.add("text-emerald-700", "bg-emerald-50/60", "font-extrabold", "shadow-inner");
          }
          th.onclick = () => { kpiSortCol = k; renderKpiTable(); };
          tr2.appendChild(th);
        });
        thead.appendChild(tr2);
        kpiTable.appendChild(thead);

        // Body - Glass cards effect
        const tbody = document.createElement('tbody');
        tbody.className = "divide-y divide-slate-200/30";
        rows.forEach((r, i) => {
          const tr = document.createElement('tr');
          tr.className = "bg-white/40 dark:bg-slate-700/40 backdrop-blur-sm hover:bg-slate-50/80 dark:hover:from-slate-600/60 dark:hover:to-slate-700/40 hover:shadow-md transition-all duration-300 group border-b border-white/20 dark:border-slate-600/20";
          tr.style.backdropFilter = "blur(8px)";
          kpiSubHeadings.forEach(k => {
            const td = document.createElement('td');
            td.className = "px-2 py-5 text-sm text-slate-700 dark:text-white border-r border-white/10 dark:border-slate-600/10 last:border-r-0";

            let val = r[k];

            // Special styling for Rep column
            if (k === 'rep') {
              td.className = "px-2 py-5 text-base font-extrabold text-slate-900 dark:text-slate-50 group-hover:text-emerald-700 dark:group-hover:text-emerald-300 group-hover:scale-105 transition-all duration-300 whitespace-nowrap border-r border-white/10 dark:border-slate-600/10 last:border-r-0";
            }

            // Special styling for Money columns - Glass pill effect
            if (DOLLAR_COLS.includes(k)) {
              td.textContent = val.toLocaleString('en-NZ', { style: 'currency', currency: 'NZD' });
              td.classList.add("font-bold", "text-right", "tabular-nums");
              if (k === 'gp') {
                td.classList.add("text-emerald-900", "!text-emerald-900", "dark:!text-emerald-100", "text-base", "bg-gradient-to-br", "from-emerald-100/70", "to-emerald-50/40", "dark:from-emerald-900/60", "dark:to-emerald-800/40", "backdrop-blur-sm", "shadow-inner", "rounded-lg", "px-3", "py-2");
                td.style.backdropFilter = "blur(8px)";
              } else if (k === 'com') {
                td.classList.add("text-teal-900", "!text-teal-900", "dark:!text-teal-100", "text-base", "bg-gradient-to-br", "from-teal-100/70", "to-teal-50/40", "dark:from-teal-900/60", "dark:to-teal-800/40", "backdrop-blur-sm", "shadow-inner", "rounded-lg", "px-3", "py-2");
                td.style.backdropFilter = "blur(8px)";
              } else {
                td.classList.add("text-slate-800", "dark:text-white", "bg-slate-50/30", "dark:bg-slate-700/50", "rounded", "px-2");
              }
            } else {
              td.textContent = val;
              if (k !== 'rep') {
                td.classList.add("text-center", "font-semibold", "text-slate-600", "dark:text-white");
              }
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        kpiTable.appendChild(tbody);

        // Footer (Totals) - Beautiful emerald gradient
        const tfoot = document.createElement('tfoot');
        const trF = document.createElement('tr');
        trF.className = "bg-gradient-to-r from-emerald-500 via-emerald-600 to-teal-600 backdrop-blur-xl text-white font-bold text-base shadow-2xl border-t-4 border-emerald-400/50 relative";
        trF.style.backdropFilter = "blur(20px)";
        trF.style.boxShadow = "0 -4px 20px rgba(16, 185, 129, 0.25), 0 4px 30px rgba(16, 185, 129, 0.15)";
        trF.style.borderRadius = "0 0 1rem 1rem";
        kpiSubHeadings.forEach(k => {
          const td = document.createElement('td');
          td.className = "px-2 py-6 border-r border-emerald-400/20 last:border-r-0";
          let val = totals[k];
          if (DOLLAR_COLS.includes(k)) {
            td.textContent = val.toLocaleString('en-NZ', { style: 'currency', currency: 'NZD' });
            td.classList.add("text-right", "tabular-nums", "tracking-wide", "text-white", "drop-shadow-lg");
          } else {
            td.textContent = val;
            if (k !== 'rep') td.classList.add("text-center");
            td.classList.add("drop-shadow-md");
          }
          trF.appendChild(td);
        });
        tfoot.appendChild(trF);
        kpiTable.appendChild(tfoot);

        document.getElementById('kpiCopyright').classList.remove('hidden');
        kpiBtnScreenshot.classList.remove('hidden');
      }

      kpiBtnScreenshot.addEventListener('click', async () => {
        const el = document.getElementById('kpiCapture');
        try {
          const canvas = await html2canvas(el);
          canvas.toBlob(async (blob) => {
            await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
            alert("Screenshot copied to clipboard!");
          });
        } catch (err) {
          console.error(err);
          alert("Screenshot failed.");
        }
      });

    })();
  </script>
</body>

</html>